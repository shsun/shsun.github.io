<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Bullet Proofing Django Models | 谢谢这个世界</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="https://medium.com/@hakibenita/bullet-proofing-django-models-c080739be4e We recently added a bank account like functionality into one of our products. During the development we encountered some textbo">
<meta property="og:type" content="article">
<meta property="og:title" content="Bullet Proofing Django Models">
<meta property="og:url" content="http://yoursite.com/2018/06/28/Bullet_Proofing_Django_Models/index.html">
<meta property="og:site_name" content="谢谢这个世界">
<meta property="og:description" content="https://medium.com/@hakibenita/bullet-proofing-django-models-c080739be4e We recently added a bank account like functionality into one of our products. During the development we encountered some textbo">
<meta property="og:updated_time" content="2018-06-28T12:42:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bullet Proofing Django Models">
<meta name="twitter:description" content="https://medium.com/@hakibenita/bullet-proofing-django-models-c080739be4e We recently added a bank account like functionality into one of our products. During the development we encountered some textbo">
  
    <link rel="alternate" href="/atom.xml" title="谢谢这个世界" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">谢谢这个世界</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Bullet_Proofing_Django_Models" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/28/Bullet_Proofing_Django_Models/" class="article-date">
  <time datetime="2018-06-28T12:42:56.000Z" itemprop="datePublished">2018-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technique/">technique</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Bullet Proofing Django Models
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://medium.com/@hakibenita/bullet-proofing-django-models-c080739be4e" target="_blank" rel="noopener">https://medium.com/@hakibenita/bullet-proofing-django-models-c080739be4e</a></p>
<p>We recently added a bank account like functionality into one of our products. During the development we encountered some textbook problems and I thought it can be a good opportunity to go over some of the patterns we use in our Django models.</p>
<p>This article was written in the order in which we usually address new problems:</p>
<ol>
<li>Define the business requirements.</li>
<li>Write down a naive implementation and model definition.</li>
<li>Challenge the solution.</li>
<li>Refine and repeat.</li>
</ol>
<p>A Bank Account<br>Business Requirements</p>
<ul>
<li>Each user can have only one account but not every user must have one.</li>
<li>The user can deposit and withdraw from the account up to a certain amount.</li>
<li>The account balance cannot be negative.</li>
<li>There is a max limit to the user’s account balance.</li>
<li>The total amount of all balances in the app cannot exceed a certain amount.</li>
<li>There must be a record for every action on the account.</li>
<li>Actions on the account can be executed by the user from either the mobile app or the web interface and by support personnel from the admin interface.</li>
</ul>
<p>Now that we have the business requirements we can start with a model definition.<br>Account Model<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'Account'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'Accounts'</span></span><br><span class="line"></span><br><span class="line">    MAX_TOTAL_BALANCES = <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">    MAX_BALANCE = <span class="number">10000</span></span><br><span class="line">    MIN_BALANCE = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    MAX_DEPOSIT = <span class="number">1000</span></span><br><span class="line">    MIN_DEPOSIT = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    MAX_WITHDRAW = <span class="number">1000</span></span><br><span class="line">    MIN_WITHDRAW = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    id = models.AutoField(</span><br><span class="line">        primary_key=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    uid = models.UUIDField(</span><br><span class="line">        unique=<span class="keyword">True</span>,</span><br><span class="line">        editable=<span class="keyword">False</span>,</span><br><span class="line">        default=uuid.uuid4,</span><br><span class="line">        verbose_name=<span class="string">'Public identifier'</span>,</span><br><span class="line">    )</span><br><span class="line">    user = models.OneToOneField(</span><br><span class="line">        settings.AUTH_USER_MODEL,</span><br><span class="line">        on_delete=models.PROTECT,</span><br><span class="line">    )</span><br><span class="line">    created = models.DateTimeField(</span><br><span class="line">        blank=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    modified = models.DateTimeField(</span><br><span class="line">        blank=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    balance = models.PositiveIntegerField(</span><br><span class="line">        verbose_name=<span class="string">'Current balance'</span>,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p>
<p>Let’s break it down:</p>
<ul>
<li>We use two unique identifiers — A private identifier which is an auto generated number (id) and a public id which is a uuid (uid). It’s a good idea to keep enumerators private — they expose important information about our data such as how many accounts we have and we don’t want that.</li>
<li>We use OneToOneField for the user. It’s like a ForeignKey but with a unique constraint. This ensures a user cannot have more than one account.</li>
<li>We set on_delete=models.PROTECT. Starting with Django 2.0 this argument will be mandatory. The default is CASCADE — when the user is deleted the related account is deleted as well. In our case this doesn’t make sense — imagine the bank “deleting your money” when you close an account. Setting on_delete=models.PROTECT will raise an IntegrityError when attempting to delete a user with an account.</li>
<li>You probably noticed that the code is very… “vertical”. This is not just because Medium has such poor support for source code — we write like that because it makes git diffs look nicer.</li>
</ul>
<p>Account Action Model</p>
<p>Now that we have an account model we can create a model to log actions made to the account:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Action</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'Account Action'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'Account Actions'</span></span><br><span class="line"></span><br><span class="line">    ACTION_TYPE_CREATED = <span class="string">'CREATED'</span></span><br><span class="line">    ACTION_TYPE_DEPOSITED = <span class="string">'DEPOSITED'</span></span><br><span class="line">    ACTION_TYPE_WITHDRAWN = <span class="string">'WITHDRAWN'</span></span><br><span class="line">    ACTION_TYPE_CHOICES = (</span><br><span class="line">        (ACTION_TYPE_CREATED, <span class="string">'Created'</span>),</span><br><span class="line">        (ACTION_TYPE_DEPOSITED, <span class="string">'Deposited'</span>),</span><br><span class="line">        (ACTION_TYPE_WITHDRAWN, <span class="string">'Withdrawn'</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    REFERENCE_TYPE_BANK_TRANSFER = <span class="string">'BANK_TRANSFER'</span></span><br><span class="line">    REFERENCE_TYPE_CHECK = <span class="string">'CHECK'</span></span><br><span class="line">    REFERENCE_TYPE_CASH = <span class="string">'CASH'</span></span><br><span class="line">    REFERENCE_TYPE_NONE = <span class="string">'NONE'</span></span><br><span class="line">    REFERENCE_TYPE_CHOICES = (</span><br><span class="line">        (REFERENCE_TYPE_BANK_TRANSFER, <span class="string">'Bank Transfer'</span>),</span><br><span class="line">        (REFERENCE_TYPE_CHECK, <span class="string">'Check'</span>),</span><br><span class="line">        (REFERENCE_TYPE_CASH, <span class="string">'Cash'</span>),</span><br><span class="line">        (REFERENCE_TYPE_NONE, <span class="string">'None'</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    id = models.AutoField(</span><br><span class="line">        primary_key=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    user_friendly_id = models.CharField(</span><br><span class="line">        unique=<span class="keyword">True</span>,</span><br><span class="line">        editable=<span class="keyword">False</span>,</span><br><span class="line">        max_length=<span class="number">30</span>,</span><br><span class="line">    )</span><br><span class="line">    user = models.ForeignKey(</span><br><span class="line">        settings.AUTH_USER_MODEL,</span><br><span class="line">        on_delete=models.PROTECT,</span><br><span class="line">        help_text=’User who performed the action.’,</span><br><span class="line">    )</span><br><span class="line">    created = models.DateTimeField(</span><br><span class="line">        blank=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    account = models.ForeignKey(</span><br><span class="line">        Account,</span><br><span class="line">    )</span><br><span class="line">    type = models.CharField(</span><br><span class="line">        max_length=<span class="number">30</span>,</span><br><span class="line">        choices=ACTION_TYPE_CHOICES,</span><br><span class="line">    )</span><br><span class="line">    delta = models.IntegerField(</span><br><span class="line">        help_text=‘Balance delta.<span class="string">',</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    reference = models.TextField(</span></span><br><span class="line"><span class="string">        blank=True,</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    reference_type = models.CharField(</span></span><br><span class="line"><span class="string">        max_length=30,</span></span><br><span class="line"><span class="string">        choices=REFERENCE_TYPE_CHOICES,</span></span><br><span class="line"><span class="string">        default=REFERENCE_TYPE_NONE,</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    comment = models.TextField(</span></span><br><span class="line"><span class="string">        blank=True,</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Fields used solely for debugging purposes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    debug_balance = models.IntegerField(</span></span><br><span class="line"><span class="string">        help_text='</span>Balance after the action.<span class="string">',</span></span><br><span class="line"><span class="string">    )</span></span><br></pre></td></tr></table></figure></p>
<p>What do we have here?</p>
<ul>
<li>Each record will hold a reference to the associated balance and the delta amount. A deposit of 100$ will have a delta of 100$, and a withdrawal of 50$ will have a delta of -50$. This way we can sum the deltas of all actions made to an account and get the current balance. This is important for validating our calculated balance.</li>
<li>We follow the same pattern of adding two identifiers — a private and a public one. The difference here is that reference numbers for actions are often used by users and support personnel to identify a specific action over the phone or in emails. A uuid is not user friendly — it’s very long and it’s not something users are used to see. I found a nice implementation of user-friendly ID’s in django-invoice.</li>
<li>Two of the fields are only relevant for one type of action, deposit — reference and reference type. There are a lot of ways to tackle this issue — table inheritance and down casting, JSON fields, table polymorphism and the list of overly complicated solutions goes on. In our case we are going to use a sparse table.</li>
</ul>
<p>Note about the design: Maintaining calculated fields in the model is usually bad design. Calculated fields such as the account’s balance should be avoided whenever possible.</p>
<p>However, in our “real life“ implementation there are additional action types and thousands of actions on each account — we treat calculated attribute as an optimization. Maintaining state poses some interesting challenges and we thought it can serve the purpose of this post so we decided to present it as well.<br>Challenges<br>Multiple Platforms</p>
<p>We have three client applications we need to support:</p>
<ul>
<li>Mobile app — use an API interface to manage the account.</li>
<li>Web client — can use either an API interface (if we have some sort of SPA) or good old server side rendering with Django forms.</li>
<li>Admin interface — uses Django’s admin module with Django forms.</li>
</ul>
<p>Our motivation is to keep things DRY and self contained as possible.<br>Validation</p>
<p>We have two types of validations hiding in the business requirements:</p>
<p>Input validation such as “amount must be between X and Y”, “balance cannot exceed Z”, etc — these types of validation are well supported by Django and can usually be expressed as database constraints or django validations.</p>
<p>The second validation is a bit more complicated. We need to ensure the total amount of all balances in the entire system does not exceed a certain amount. This forces us to validate an instance against all other instances of the model.<br>Atomicity</p>
<p>Race conditions are a very common issue in distributed systems and ever more so in models that maintain state such as bank account (you can read more about race conditions in Wikipedia).</p>
<p>To illustrate the problem consider an account with a balance of 100$. The user connects from two different devices at the exact same time and issue a withdraw of 100$. Since the two actions were executed at the exact same time it is possible that both of them get a current balance of 100$. Given that both session see sufficient balance they will both get approved and update the new balance to 0$. The user withdrawn a total of 200$ and the current balance is now 0$ — we have a race condition and we are down 100$.<br>Logging / History</p>
<p>The log serves two purposes:</p>
<ul>
<li>Log and Audit — Information about historical actions — dates, amounts, users etc.</li>
<li>Check Consistency — We maintain state in the model so we want to be able to validate the calculated balance by aggregating the action deltas.</li>
</ul>
<p>The history records must be 100% immutable.<br>The Naive Implementation</p>
<p>Let’s start with a naive implementation of deposit (this is not a good implementation):<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(self, amount, deposited_by, asof)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> amount &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.MIN_DEPOSIT &lt;= amount &lt;= self.MAX_DEPOSIT:</span><br><span class="line">            <span class="keyword">raise</span> InvalidAmount(amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.balance + amount &gt; self.MAX_BALANCE:</span><br><span class="line">            <span class="keyword">raise</span> ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        total = Account.objects.aggregate(</span><br><span class="line">            total=Sum(<span class="string">'balance'</span>)</span><br><span class="line">        )[<span class="string">'total'</span>]</span><br><span class="line">        <span class="keyword">if</span> total + amount &gt; self.MAX_TOTAL_BALANCES:</span><br><span class="line">            <span class="keyword">raise</span> ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        action = self.actions.create(</span><br><span class="line">            user=deposited_by,</span><br><span class="line">            type=Action.ACTION_TYPE_DEPOSITED,</span><br><span class="line">            delta=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.balance += amount</span><br><span class="line">        self.modified = asof</span><br><span class="line"></span><br><span class="line">        self.save()</span><br></pre></td></tr></table></figure></p>
<p>And let’s add a simple endpoint for it using DRF @api_view:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api.py</span></span><br><span class="line"></span><br><span class="line">…</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> transaction</span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view('POST')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        amount = int(request.data[<span class="string">'amount'</span>])</span><br><span class="line">    <span class="keyword">except</span> (KeyError, ValueError):</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            account = (</span><br><span class="line">                Account.objects</span><br><span class="line">                .select_for_update()</span><br><span class="line">                .get(user=request.user)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> Account.DoesNotExist:</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            account.deposit(</span><br><span class="line">                amount=amount,</span><br><span class="line">                deposited_by=request.user,</span><br><span class="line">                asof=timezone.now(),</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> (ExceedsLimit, InvalidAmount):</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_200_OK)</span><br></pre></td></tr></table></figure></p>
<p>So what is the problem?</p>
<ul>
<li><p>Locking the account — An instance cannot lock itself because it had already been fetched. We gave up control over the locking and fetching so we have to trust the caller to properly obtain a lock — this is very bad design. Don’t take my word for it, let’s take a glimpse at Django’s design philosophy:</p>
</li>
<li><p>Loose coupling<br>  A fundamental goal of Django’s stack is loose coupling and tight cohesion. The various layers of the framework shouldn’t “know” about each other unless absolutely necessary.</p>
</li>
</ul>
<p>So is it really the business of our API, forms and django admin to fetch the account for us and obtain a proper lock? I think not.</p>
<ol>
<li>Validation — The account has to validate itself against all other accounts — this just feels awkward.<br>A Better Approach</li>
</ol>
<p>We need to hook into the process before the account is fetched (to obtain a lock) and in a place where it makes sense to validate and process more than one account.</p>
<p>Let’s start with a function to create an Action instance and write it as a classmethod:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Action</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    …</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        cls,</span></span></span><br><span class="line"><span class="function"><span class="params">        user,</span></span></span><br><span class="line"><span class="function"><span class="params">        account,</span></span></span><br><span class="line"><span class="function"><span class="params">        type,</span></span></span><br><span class="line"><span class="function"><span class="params">        delta,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof,</span></span></span><br><span class="line"><span class="function"><span class="params">        reference=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        reference_type=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        comment=None,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        <span class="string">"""Create Action.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        user (User):</span></span><br><span class="line"><span class="string">            User who executed the action.</span></span><br><span class="line"><span class="string">        account (Account):</span></span><br><span class="line"><span class="string">            Account the action executed on.</span></span><br><span class="line"><span class="string">        type (str, one of Action.ACTION_TYPE_*):</span></span><br><span class="line"><span class="string">            Type of action.</span></span><br><span class="line"><span class="string">        delta (int):</span></span><br><span class="line"><span class="string">            Change in balance.</span></span><br><span class="line"><span class="string">        asof (datetime.datetime):</span></span><br><span class="line"><span class="string">            When was the action executed.</span></span><br><span class="line"><span class="string">        reference (str or None):</span></span><br><span class="line"><span class="string">            Reference number when appropriate.</span></span><br><span class="line"><span class="string">        reference_type(str or None):</span></span><br><span class="line"><span class="string">            Type of reference.</span></span><br><span class="line"><span class="string">            Defaults to "NONE".</span></span><br><span class="line"><span class="string">        comment (str or None):</span></span><br><span class="line"><span class="string">            Optional comment on the action.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ValidationError</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns (Action)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> asof <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type == cls.ACTION_TYPE_DEPOSITED <span class="keyword">and</span></span><br><span class="line">            reference_type <span class="keyword">is</span> <span class="keyword">None</span>):</span><br><span class="line">            <span class="keyword">raise</span> errors.ValidationError(&#123;</span><br><span class="line">                <span class="string">'reference_type’: ‘required for deposit.'</span>,  </span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> reference_type <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            reference_type = cls.REFERENCE_TYPE_NONE</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Don't store null in text field.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> reference <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            reference = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> comment <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            comment = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        user_friendly_id = generate_user_friendly_id()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls.objects.create(</span><br><span class="line">            user_friendly_id=user_friendly_id,</span><br><span class="line">            created=asof,</span><br><span class="line">            user=user,</span><br><span class="line">            account=account,</span><br><span class="line">            type=type,</span><br><span class="line">            delta=delta,</span><br><span class="line">            reference=reference,</span><br><span class="line">            reference_type=reference_type,</span><br><span class="line">            comment=comment,</span><br><span class="line">            debug_balance=account.balance,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure></p>
<p>What do we have here:</p>
<ul>
<li>We used a classmethod that accepts all necessary data to validate and create the new instance. By <em>not</em> using the default manager’s create function (Action.objects.create) we encapsulate all the business logic in the creation process.</li>
<li>We easily introduced custom validation and raise proper ValidationError.</li>
<li>We accept the creation time as an argument. That might seem a bit strange at first glance — why not use the built in auto_time_add? For starters It’s much easier to test with predictable values. Second, as we are going to see in just a bit, we can make sure the modified time of the account is exactly the same as the action created time.</li>
</ul>
<p>Before moving over to the implementation of the account methods let’s define custom exceptions for our Account module:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># errors.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Error</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExceedsLimit</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvalidAmount</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, amount)</span>:</span></span><br><span class="line">        self.amount = amount</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(str)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid Amount: &#123;&#125;'</span>.format(amount)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InsufficientFunds</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, balance, amount)</span>:</span></span><br><span class="line">        self.balance = balance</span><br><span class="line">        self.amount = amount</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'amount: &#123;&#125;, current balance: &#123;&#125;'</span>.format(</span><br><span class="line">                self.amount, self.balance)</span><br></pre></td></tr></table></figure></p>
<p>We define a base Error class that inherits from Exception. This is something we found very useful and we use it a lot. A base error class allows us to catch all errors coming from a certain module:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> account.errors <span class="keyword">import</span> Error <span class="keyword">as</span> AccountError</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   <span class="comment"># action on account</span></span><br><span class="line"><span class="keyword">except</span> AccountError:</span><br><span class="line">   <span class="comment"># Handle all errors from account</span></span><br></pre></td></tr></table></figure></p>
<p>A similar pattern can be found in the popular requests package.</p>
<p>Let’s implement the method to create a new Account:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls, user, created_by, asof)</span>:</span></span><br><span class="line">        <span class="string">"""Create account.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        user (User):</span></span><br><span class="line"><span class="string">            Owner of the account.</span></span><br><span class="line"><span class="string">        created_by (User):</span></span><br><span class="line"><span class="string">            User that created the account.</span></span><br><span class="line"><span class="string">        asof (datetime.datetime):</span></span><br><span class="line"><span class="string">            Time of creation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns (tuple):</span></span><br><span class="line"><span class="string">            [0] Account</span></span><br><span class="line"><span class="string">            [1] Action</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">            account = cls.objects.create(</span><br><span class="line">                user=user,</span><br><span class="line">                created=asof,</span><br><span class="line">                modified=asof,</span><br><span class="line">                balance=<span class="number">0</span>,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            action = Action.create(</span><br><span class="line">                user=created_by,</span><br><span class="line">                account=account,</span><br><span class="line">                type=Action.ACTION_TYPE_CREATED,</span><br><span class="line">                delta=<span class="number">0</span>,</span><br><span class="line">                asof=asof,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> account, action</span><br></pre></td></tr></table></figure></p>
<p>Pretty straight forward — create the instance, create the action and return them both.</p>
<p>Notice how we accept asof here as well — modified, created and the action creation time are all equal — you cant do that with auto_add and auto_add_now.</p>
<p>Now to the business logic:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    cls,</span></span></span><br><span class="line"><span class="function"><span class="params">    uid,</span></span></span><br><span class="line"><span class="function"><span class="params">    deposited_by,</span></span></span><br><span class="line"><span class="function"><span class="params">    amount,</span></span></span><br><span class="line"><span class="function"><span class="params">    asof,</span></span></span><br><span class="line"><span class="function"><span class="params">    comment=None,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="string">"""Deposit to account.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    uid (uuid.UUID):</span></span><br><span class="line"><span class="string">        Account public identifier.</span></span><br><span class="line"><span class="string">    deposited_by (User):</span></span><br><span class="line"><span class="string">        Deposited by.</span></span><br><span class="line"><span class="string">    amount (positive int):</span></span><br><span class="line"><span class="string">        Amount to deposit.</span></span><br><span class="line"><span class="string">    asof (datetime.datetime):</span></span><br><span class="line"><span class="string">        Time of deposit.</span></span><br><span class="line"><span class="string">    comment(str or None):</span></span><br><span class="line"><span class="string">       Optional comment.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises</span></span><br><span class="line"><span class="string">        Account.DoesNotExist</span></span><br><span class="line"><span class="string">        InvalidAmount</span></span><br><span class="line"><span class="string">        ExceedsLimit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns (tuple):</span></span><br><span class="line"><span class="string">        [0] (Account) Updated account instance.</span></span><br><span class="line"><span class="string">        [0] (Action) Deposit action.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">assert</span> amount &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        account = cls.objects.select_for_update().get(uid=uid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (cls.MIN_DEPOSIT &lt;= amount &lt;= cls.MAX_DEPOSIT):</span><br><span class="line">            <span class="keyword">raise</span> errors.InvalidAmount(amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> account.balance + amount &gt; cls.MAX_BALANCE:</span><br><span class="line">            <span class="keyword">raise</span> errors.ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        total = cls.objects.aggregate(total=Sum(<span class="string">'balance'</span>))[<span class="string">'total'</span>]</span><br><span class="line">        <span class="keyword">if</span> total + amount &gt; cls.MAX_TOTAL_BALANCES:</span><br><span class="line">            <span class="keyword">raise</span> errors.ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        account.balance += amount</span><br><span class="line">        account.modified = asof</span><br><span class="line"></span><br><span class="line">        account.save(update_fields=[</span><br><span class="line">            <span class="string">'balance'</span>,</span><br><span class="line">            <span class="string">'modified'</span>,</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        action = Action.create(</span><br><span class="line">            user=deposited_by,</span><br><span class="line">            account=account,</span><br><span class="line">            type=Action.ACTION_TYPE_DEPOSITED,</span><br><span class="line">            delta=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> account, action</span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">withdraw</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    cls,</span></span></span><br><span class="line"><span class="function"><span class="params">    uid,</span></span></span><br><span class="line"><span class="function"><span class="params">    withdrawn_by,</span></span></span><br><span class="line"><span class="function"><span class="params">    amount,</span></span></span><br><span class="line"><span class="function"><span class="params">    asof</span></span></span><br><span class="line"><span class="function"><span class="params">    comment=None,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="string">"""Withdraw from account.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    uid (uuid.UUID):</span></span><br><span class="line"><span class="string">        Account public identifier.</span></span><br><span class="line"><span class="string">    withdrawn_by (User):</span></span><br><span class="line"><span class="string">        The withdrawing user.</span></span><br><span class="line"><span class="string">    amount (positive int):</span></span><br><span class="line"><span class="string">        Amount to withdraw.</span></span><br><span class="line"><span class="string">    asof (datetime.datetime):</span></span><br><span class="line"><span class="string">        Time of withdraw.</span></span><br><span class="line"><span class="string">    comment (str or None):</span></span><br><span class="line"><span class="string">       Optional comment.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        Account.DoesNotExist</span></span><br><span class="line"><span class="string">        InvalidAmount</span></span><br><span class="line"><span class="string">        InsuficientFunds</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns (tuple):</span></span><br><span class="line"><span class="string">        [0] (Account) Updated account instance.</span></span><br><span class="line"><span class="string">        [0] (Action) Withdraw action.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">assert</span> amount &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        account = cls.objects.select_for_update().get(uid=uid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (cls.MIN_WITHDRAW &lt;= amount &lt;= cls.MAX_WITHDRAW):</span><br><span class="line">            <span class="keyword">raise</span> InvalidAmount(amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> account.balance - amount &lt; cls.MIN_BALANCE:</span><br><span class="line">            <span class="keyword">raise</span> InsufficientFunds(amount, account.balance)</span><br><span class="line"></span><br><span class="line">        account.balance -= amount</span><br><span class="line">        account.modified = asof</span><br><span class="line"></span><br><span class="line">        account.save(update_fields=[</span><br><span class="line">            <span class="string">'balance'</span>,</span><br><span class="line">            <span class="string">'modified'</span>,</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        action = Action.create(</span><br><span class="line">            user=withdrawn_by,</span><br><span class="line">            account=account,</span><br><span class="line">            type=Action.ACTION_TYPE_WITHDRAWN,</span><br><span class="line">            delta=-amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> account, action</span><br></pre></td></tr></table></figure></p>
<p>We can start to see the pattern here:</p>
<ul>
<li>Acquire a lock on the account using select_for_update. This will lock the account row in the database and make sure no one can update the account instance until the transaction is completed (either committed or rolled-back).</li>
<li>Perform validation checks and raise proper exceptions — raising an exception will cause the transaction to rollback.<br>  If all the validations passed update the state (current balance), set the modification time, save the instance and create the log (action).</li>
</ul>
<p>So how does the model hold up to our challenges?</p>
<ul>
<li>Multiple Platforms and Validation — We encapsulated all of our business logic including input and system wide validation inside the model method so consumers such as API, admin action or forms only need to handle exceptions and serialization / UI.</li>
<li>Atomicity — Each method obtains its own lock so there is no risk of race condition.<br>  Logging / History — We created an action model and made sure each function registers the proper action.</li>
</ul>
<p>Profit!<br>Testing</p>
<p>Our app will be incomplete without proper tests. I previously wrote about class based testings — we are going to take a slightly different approach but still have a base class with utility functions:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/common.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestAccountBase</span>:</span></span><br><span class="line"></span><br><span class="line">    DEFAULT = object()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default</span><span class="params">(value, default_value)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> default_value <span class="keyword">if</span> value <span class="keyword">is</span> cls.DEFAULT <span class="keyword">else</span> value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUpTestData</span><span class="params">(cls)</span>:</span></span><br><span class="line">        super().setUpTestData()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Set up some default values</span></span><br><span class="line">        cls.admin = User.objects.create_superuser(</span><br><span class="line">            <span class="string">'Admin'</span>,</span><br><span class="line">            <span class="string">'admin'</span>,</span><br><span class="line">            <span class="string">'admin@testing.test'</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        cls.user_A = User.objects.create_user(</span><br><span class="line">            <span class="string">'user_A'</span>,</span><br><span class="line">            <span class="string">'user_A'</span>,</span><br><span class="line">            <span class="string">'A@testing.test'</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        cls,</span></span></span><br><span class="line"><span class="function"><span class="params">        user=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        created_by=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof=DEFAULT</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        user = cls.default(user, cls.user_A)</span><br><span class="line">        created_by = cls.default(created_by, cls.admin)</span><br><span class="line">        asof = cls.default(asof, timezone.now())</span><br><span class="line"></span><br><span class="line">        account, action = Account.create(user, created_by, asof)</span><br><span class="line">        <span class="keyword">return</span> cls.account, action</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        amount,</span></span></span><br><span class="line"><span class="function"><span class="params">        account=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        deposited_by=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        comment=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        account = self.default(account, self.account)</span><br><span class="line">        deposited_by = self.default(deposited_by, self.admin)</span><br><span class="line">        asof = self.default(asof, timezone.now())</span><br><span class="line">        comment = self.default(comment, ‘deposit comment’)</span><br><span class="line"></span><br><span class="line">        self.account, action = Account.deposit(</span><br><span class="line">            uid=account.uid,</span><br><span class="line">            deposited_by=deposited_by,</span><br><span class="line">            amount=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.assertEqual(action.type, Action.ACTION_TYPE_DEPOSITED)</span><br><span class="line">        self.assertIsNotNone(action.user_friendly_id)</span><br><span class="line">        self.assertEqual(action.created, asof)</span><br><span class="line">        self.assertEqual(action.delta, amount)</span><br><span class="line">        self.assertEqual(action.user, deposited_by)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> action</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">withdraw</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        amount,</span></span></span><br><span class="line"><span class="function"><span class="params">        account=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        withdrawn_by=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        comment=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        account = self.default(account, self.account)</span><br><span class="line">        withdrawn_by = self.default(withdrawn_by, self.admin)</span><br><span class="line">        asof = self.default(asof, timezone.now())</span><br><span class="line">        comment = self.default(comment, ‘withdraw comment’)</span><br><span class="line"></span><br><span class="line">        self.account, action = Account.withdraw(</span><br><span class="line">            uid=account.uid,</span><br><span class="line">            withdrawn_by=withdrawn_by,</span><br><span class="line">            amount=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.assertEqual(action.type, Action.ACTION_TYPE_WITHDRAWN)</span><br><span class="line">        self.assertIsNotNone(action.user_friendly_id)</span><br><span class="line">        self.assertEqual(action.created, asof)</span><br><span class="line">        self.assertEqual(action.delta, amount)</span><br><span class="line">        self.assertEqual(action.user, withdrawn_by)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> action</span><br></pre></td></tr></table></figure></p>
<p>To make testing easier to write we use utility functions to reduce the boilerplate of specifying the user, the account etc each time by providing default values and operating on self.account.</p>
<p>Lets use our base class to write some tests:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/test_account.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> mock</span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .common <span class="keyword">import</span> TestAccoutBase</span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> Account, Action</span><br><span class="line"><span class="keyword">from</span> ..errors <span class="keyword">import</span> (</span><br><span class="line">    InvalidAmount,</span><br><span class="line">    ExceedsLimit,</span><br><span class="line">    InsuficientFunds,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestAccount</span><span class="params">(TestAccountBase, TestCase)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.account, _ = cls.create()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_start_with_zero_balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_deposit</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.deposit(<span class="number">100</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">100</span>)</span><br><span class="line">        self.deposit(<span class="number">150</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">250</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_to_deposit_less_than_minimum</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(InvalidAmount):</span><br><span class="line">            self.deposit(Account.MIN_DEPOSIT - <span class="number">1</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_to_deposit_more_than_maximum</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(InvalidAmount):</span><br><span class="line">            self.deposit(Account.MAX_DEPOSIT + <span class="number">1</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_BALANCE', 500)</span></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_DEPOSIT', 502)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_to_deposit_more_than_max_balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(ExceedsLimit):</span><br><span class="line">            self.deposit(<span class="number">501</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_BALANCE', 500)</span></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_DEPOSIT', 500)</span></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_TOTAL_BALANCES', 600)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_when_exceed_max_total_balances</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Exceed max total balances for the same account</span></span><br><span class="line"></span><br><span class="line">        self.deposit(<span class="number">500</span>)</span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(ExceedsLimit):</span><br><span class="line">            self.deposit(<span class="number">500</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Exceed max total balances in other account</span></span><br><span class="line"></span><br><span class="line">        other_user = User.objects.create_user(<span class="string">'foo'</span>, <span class="string">'bar'</span>, <span class="string">'baz'</span>)</span><br><span class="line">        other_account = self.create(user=other_user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(ExceedsLimit):</span><br><span class="line">            self.deposit(<span class="number">200</span>, account=other_account)</span><br><span class="line">        self.assertEqual(other_account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_withdraw</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.deposit(<span class="number">100</span>)</span><br><span class="line">        self.withdraw(<span class="number">50</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">50</span>)</span><br><span class="line">        self.withdraw(<span class="number">30</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_when_insufficient_funds</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.deposit(<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(InsufficientFunds):</span><br><span class="line">            self.withdraw(<span class="number">101</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">100</span>)</span><br></pre></td></tr></table></figure></p>
<p>Final Words</p>
<p>The classmethod approach has proved itself in our development for quite some time now. We found that it provides the necessary flexibility, readability and testability with very little overhead.</p>
<p>In this article we presented two common issues we encounter frequently — validation and concurrency. This method can be extended to handle access control (permissions) and caching (we have total control over the fetch, remember?), performance optimization (use select_related and update_fields…), audit and monitoring and additional business logic.</p>
<p>We usually support several interfaces for each model — admin interface for support, API for mobile and SPA clients, and a dashboard. Encapsulating the business logic inside the model reduced the amount of code duplication and required tests which leads to overall quality code that is easy to maintain.</p>
<p>In a follow up post I (might) present the admin interface for this model with some neat tricks (such as custom actions, intermediate pages etc) and possibly an RPC implementation using DRF to interact with the account as an API.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/28/Bullet_Proofing_Django_Models/" data-id="cjy6jpqxt0000q4n4j3wdyb80" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/07/05/how_to_install_virtualenv/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          how_to_install_virtualenv
        
      </div>
    </a>
  
  
    <a href="/2018/06/28/How_to_manage_concurrency_in_Django_models/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">How to manage concurrency in Django models</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/economics/">economics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technique/">technique</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/03/kulese_经典观点/">kulese_经典观点</a>
          </li>
        
          <li>
            <a href="/2019/07/02/install_proxy_server_squid3_on_ubuntu/">install_proxy_server_squid3_on_ubuntu</a>
          </li>
        
          <li>
            <a href="/2019/06/05/基金分析_2011年08月30日/">基金分析_2011年08月30日</a>
          </li>
        
          <li>
            <a href="/2019/06/05/基金分析_逃离金融街/">基金分析_逃离金融街</a>
          </li>
        
          <li>
            <a href="/2019/06/05/基金分析_万事静观皆自得_四时佳兴与人同/">基金分析_万事静观皆自得_四时佳兴与人同</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>