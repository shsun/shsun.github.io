<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>谢谢这个世界</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="谢谢这个世界">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="谢谢这个世界">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="谢谢这个世界">
  
    <link rel="alternate" href="/atom.xml" title="谢谢这个世界" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">谢谢这个世界</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-how_to_install_virtualenv" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/05/how_to_install_virtualenv/" class="article-date">
  <time datetime="2018-07-05T02:33:49.000Z" itemprop="datePublished">2018-07-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technique/">technique</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/05/how_to_install_virtualenv/">how_to_install_virtualenv</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432712108300322c61f256c74803b43bfd65c6f8d0d0000" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432712108300322c61f256c74803b43bfd65c6f8d0d0000</a></p>
<p>which python<br>which python3<br>1 #创建python2.7虚拟环境<br>2 virtualenv -p /usr/bin/python2.7 ENV2.7<br>3<br>4 #创建python3.4虚拟环境<br>5 virtualenv -p /usr/local/bin/python3.4 ENV3.4</p>
<p>在开发Python应用程序的时候，系统安装的Python3只有一个版本：3.4。所有第三方的包都会被pip安装到Python3的site-packages目录下。</p>
<p>如果我们要同时开发多个应用程序，那这些应用程序都会共用一个Python，就是安装在系统的Python 3。如果应用A需要jinja 2.7，而应用B需要jinja 2.6怎么办？</p>
<p>这种情况下，每个应用可能需要各自拥有一套“独立”的Python运行环境。virtualenv就是用来为一个应用创建一套“隔离”的Python运行环境。</p>
<p>首先，我们用pip安装virtualenv：</p>
<p>$ pip3 install virtualenv<br>然后，假定我们要开发一个新的项目，需要一套独立的Python运行环境，可以这么做：</p>
<p>第一步，创建目录：</p>
<p>Mac:~ michael$ mkdir myproject<br>Mac:~ michael$ cd myproject/<br>Mac:myproject michael$<br>第二步，创建一个独立的Python运行环境，命名为venv：</p>
<p>Mac:myproject michael$ virtualenv –no-site-packages venv<br>Using base prefix ‘/usr/local/…/Python.framework/Versions/3.4’<br>New python executable in venv/bin/python3.4<br>Also creating executable in venv/bin/python<br>Installing setuptools, pip, wheel…done.<br>命令virtualenv就可以创建一个独立的Python运行环境，我们还加上了参数–no-site-packages，这样，已经安装到系统Python环境中的所有第三方包都不会复制过来，这样，我们就得到了一个不带任何第三方包的“干净”的Python运行环境。</p>
<p>新建的Python环境被放到当前目录下的venv目录。有了venv这个Python环境，可以用source进入该环境：</p>
<p>Mac:myproject michael$ source venv/bin/activate<br>(venv)Mac:myproject michael$<br>注意到命令提示符变了，有个(venv)前缀，表示当前环境是一个名为venv的Python环境。</p>
<p>下面正常安装各种第三方包，并运行python命令：</p>
<p>(venv)Mac:myproject michael$ pip install jinja2<br>…<br>Successfully installed jinja2-2.7.3 markupsafe-0.23<br>(venv)Mac:myproject michael$ python myapp.py<br>…<br>在venv环境下，用pip安装的包都被安装到venv这个环境下，系统Python环境不受任何影响。也就是说，venv环境是专门针对myproject这个应用创建的。</p>
<p>退出当前的venv环境，使用deactivate命令：</p>
<p>(venv)Mac:myproject michael$ deactivate<br>Mac:myproject michael$<br>此时就回到了正常的环境，现在pip或python均是在系统Python环境下执行。</p>
<p>完全可以针对每个应用创建独立的Python运行环境，这样就可以对每个应用的Python环境进行隔离。</p>
<p>virtualenv是如何创建“独立”的Python运行环境的呢？原理很简单，就是把系统Python复制一份到virtualenv的环境，用命令source venv/bin/activate进入一个virtualenv环境时，virtualenv会修改相关环境变量，让命令python和pip均指向当前的virtualenv环境。</p>
<p>小结<br>virtualenv为应用提供了隔离的Python运行环境，解决了不同应用间多版本的冲突问题。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/05/how_to_install_virtualenv/" data-id="cjj7xy5gy000bwes6k0hmksf5" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-How_to_manage_concurrency_in_Django_models" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/28/How_to_manage_concurrency_in_Django_models/" class="article-date">
  <time datetime="2018-06-28T12:09:46.000Z" itemprop="datePublished">2018-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technique/">technique</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/28/How_to_manage_concurrency_in_Django_models/">How to manage concurrency in Django models</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://medium.com/@hakibenita/how-to-manage-concurrency-in-django-models-b240fed4ee2" target="_blank" rel="noopener">https://medium.com/@hakibenita/how-to-manage-concurrency-in-django-models-b240fed4ee2</a></p>
<p>The days of desktop systems serving single users are long gone — web applications nowadays are serving millions of users at the same time. With many users comes a wide range of new problems — concurrency problems.</p>
<p>In this article I’m going to present two approaches for managing concurrency in Django models.<br>Photo by Denys Nevozhai<br>The Problem</p>
<p>To demonstrate common concurrency issues we are going to work on a bank account model:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    id = models.AutoField(</span><br><span class="line">        primary_key=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    user = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">    )</span><br><span class="line">    balance = models.IntegerField(</span><br><span class="line">        default=<span class="number">0</span>,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p>
<p>To get started we are going to implement a naive deposit and withdraw methods for an account instance:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(self, amount)</span>:</span></span><br><span class="line">    self.balance += amount</span><br><span class="line">    self.save()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">withdraw</span><span class="params">(self, amount)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> amount &gt; self.balance:</span><br><span class="line">        <span class="keyword">raise</span> errors.InsufficientFunds()</span><br><span class="line"></span><br><span class="line">    self.balance -= amount</span><br><span class="line">    self.save()</span><br></pre></td></tr></table></figure></p>
<p>This seems innocent enough and it might even pass unit tests and integration tests on localhost. But, what happens when two users perform actions on the same account at the same time?</p>
<ol>
<li>User A fetches the account — balance is 100$.</li>
<li>User B fetches the account — balance is 100$.</li>
<li>User B withdraws 30$ — balance is updated to 100$ — 30$ = 70$.</li>
<li>User A deposits 50$ — balance is updated to 100$ + 50$ = 150$.</li>
</ol>
<p>What happened here?</p>
<p>User B asked to withdraw 30$ and user A deposited 50$ — we expect the balance to be 120$, but we ended up with 150$.<br>Why did it happen?</p>
<p>At step 4, when user A updated the balance, the amount he had stored in memory was stale (user B had already withdrawn 30$).</p>
<p>To prevent this situation from happening we need to make sure the resource we are working on is not altered while we are working on it.<br>Pessimistic approach</p>
<p>The pessimistic approach dictates that you should lock the resource exclusively until you are finished with it. If nobody else can acquire a lock on the object while you are working on it, you can be sure the object was not changed.</p>
<p>To acquire a lock on a resource we use a database lock for several reasons:</p>
<ul>
<li>(relational) databases are very good at managing locks and maintaining consistency.</li>
<li>The database is the lowest level in which data is accessed — acquiring the lock at the lowest level will protect the data from other processes modifying the data as well. For example, direct updates in the DB, cron jobs, cleanup tasks, etc.</li>
<li>A Django app can run on multiple processes (e.g workers). Maintaining locks at the app level will require a lot of (unnecessary) work.</li>
</ul>
<p>To lock an object in Django we use select_for_update.</p>
<p>Let’s use the pessimistic approach to implement a safe deposit and withdraw:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(cls, id, amount)</span>:</span></span><br><span class="line">   <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">       account = (</span><br><span class="line">           cls.objects</span><br><span class="line">           .select_for_update()</span><br><span class="line">           .get(id=id)</span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line">       account.balance += amount</span><br><span class="line">       account.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> account</span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">withdraw</span><span class="params">(cls, id, amount)</span>:</span></span><br><span class="line">   <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">       account = (</span><br><span class="line">           cls.objects</span><br><span class="line">           .select_for_update()</span><br><span class="line">           .get(id=id)</span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> account.balance &lt; amount:</span><br><span class="line">           <span class="keyword">raise</span> errors.InsufficentFunds()</span><br><span class="line"></span><br><span class="line">       account.balance -= amount</span><br><span class="line">       account.save()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> account</span><br></pre></td></tr></table></figure></p>
<p>What do we have here:</p>
<ol>
<li>We use select_for_update on our queryset to tell the database to lock the object until the transaction is done.</li>
<li>Locking a row in the database requires a database transaction — we use Django’s decorator transaction.atomic() to scope the transaction.</li>
<li>We use a classmethod instead of an instance method — to acquire the lock we need to tell the database to lock it. To achieve that we need to be the ones fetching the object from the database. When operating on self the object is already fetched and we don’t have any guaranty that it was locked.</li>
<li>All the operations on the account are executed within the database transaction.</li>
</ol>
<p>Let’s see how the scenario from earlier is prevented with our new implementation:</p>
<ol>
<li>User A asks to withdraw 30$:<ul>
<li>User A acquires a lock on the account.</li>
<li>Balance is 100$.</li>
</ul>
</li>
<li>User B asks to deposit 50$:<ul>
<li>Attempt to acquire lock on account fails (locked by user A).</li>
<li>User B waits for the lock to release.</li>
</ul>
</li>
<li>User A withdraw 30$ :<ul>
<li>Balance is 70$.</li>
<li>Lock of user A on account is released.</li>
</ul>
</li>
<li>User B acquires a lock on the account.<ul>
<li>Balance is 70$.</li>
<li>New balance is 70$ + 50$ = 120$.</li>
</ul>
</li>
<li>Lock of user B on account is released, balance is 120$.</li>
</ol>
<p>Bug prevented!</p>
<p>What you need to know about select_for_update:</p>
<ul>
<li>In our scenario user B waited for user A to release the lock. Instead of waiting we can tell Django not to wait for the lock to release and raise a DatabaseError instead. To do that we can set the nowait argument of select_for_update to True, …select_for_update(nowait=True).</li>
<li>Select related objects are also locked — When using select_for_update with select_related, the related objects are also locked.</li>
<li>For example, If we were to select_related the user along with the account, both the user and the account will be locked. If during deposit, for example, someone is trying to update the first name, that update will fail because the user object is locked.</li>
<li>If you are using PostgreSQL or Oracle this might not be a problem soon thanks to a new feature in the upcoming Django 2.0. In this version, select_for_update has an “of” option to explicitly state which of the tables in the query to lock.</li>
</ul>
<p>I used the bank account example in the past to demonstrate common patterns we use in Django models. You are welcome to follow up in this article:<br>Bullet Proofing Django Models</p>
<p>We recently added a bank account like functionality into one of our products. During the development we encountered…<br>medium.com<br>Optimistic Approach</p>
<p>Unlike the pessimistic approach, the optimistic approach does not require a lock on the object. The optimistic approach assumes collisions are not very common, and dictates that one should only make sure there were no changes made to the object at the time it is updated.<br>How can we implement such a thing with Django?</p>
<p>First, we add a column to keep track of changes made to the object:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">version = models.IntegerField(</span><br><span class="line">    default=<span class="number">0</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>Then, when we update an object we make sure the version did not change:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(self, id, amount)</span>:</span></span><br><span class="line">   updated = Account.objects.filter(</span><br><span class="line">       id=self.id,</span><br><span class="line">       version=self.version,</span><br><span class="line">   ).update(</span><br><span class="line">       balance=balance + amount,</span><br><span class="line">       version=self.version + <span class="number">1</span>,</span><br><span class="line">   )</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> updated &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">withdraw</span><span class="params">(self, id, amount)</span>:</span>       </span><br><span class="line">   <span class="keyword">if</span> self.balance &lt; amount:</span><br><span class="line">       <span class="keyword">raise</span> errors.InsufficentFunds()</span><br><span class="line"></span><br><span class="line">   updated = Account.objects.filter(</span><br><span class="line">       id=self.id,</span><br><span class="line">       version=self.version,</span><br><span class="line">   ).update(</span><br><span class="line">       balance=balance - amount,</span><br><span class="line">       version=self.version + <span class="number">1</span>,</span><br><span class="line">   )</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> updated &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>Let’s break it down:</p>
<ol>
<li>We operate directly on the instance (no classmethod).</li>
<li>We rely on the fact that the version is incremented every time the object is updated.</li>
<li>We update only if the version did not change:<ul>
<li>If the object was not modified since we fetched it than the object is updated.</li>
<li>If it was modified than the query will return zero records and the object will not be updated.</li>
</ul>
</li>
<li>Django returns the number of updated rows. If <code>updated</code> is zero it means someone else changed the object from the time we fetched it.</li>
</ol>
<p>How is optimistic locking work in our scenario:</p>
<ol>
<li>User A fetch the account — balance is 100$, version is 0.</li>
<li>User B fetch the account — balance is 100$, version is 0.</li>
<li>User B asks to withdraw 30$:<ul>
<li>Balance is updated to 100$ — 30$ = 70$.</li>
<li>Version is incremented to 1.</li>
</ul>
</li>
<li>User A asks to deposit 50$:<ul>
<li>The calculated balance is 100$ + 50$ = 150$.</li>
<li>The account does not exist with version 0 -&gt; nothing is updated.</li>
</ul>
</li>
</ol>
<p>What you need to know about the optimistic approach:</p>
<ul>
<li>Unlike the pessimistic approach, this approach requires an additional field and a lot of discipline.</li>
<li>One way to overcome the discipline issue is to abstract this behavior. django-fsm implements optimistic locking using a version field as described above. django-optimistic-lock seem to do the same. We haven’t used any of these packages but we’ve taken some inspiration from them.</li>
<li>In an environment with a lot of concurrent updates this approach might be wasteful.</li>
<li>This approach does not protect from modifications made to the object outside the app. If you have other tasks that modify the data directly (e.g no through the model) you need to make sure they use the version as well.</li>
<li>Using the optimistic approach the function can fail and return false. In this case we will most likely want to retry the operation. Using the pessimistic approach with nowait=False the operation cannot fail — it will wait for the lock to release.</li>
</ul>
<p>Which one should I use?</p>
<p>Like any great question, the answer is “it depends”:</p>
<ul>
<li>If your object has a lot of concurrent updates you are probably better off with the pessimistic approach.</li>
<li>If you have updates happening outside the ORM (for example, directly in the database) the pessimistic approach is safer.</li>
<li>If your method has side effects such as remote API calls or OS calls make sure they are safe. Some things to consider — can the remote call take a long time? Is the remote call idempotent (safe to retry)?</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/28/How_to_manage_concurrency_in_Django_models/" data-id="cjj7xy5gu0004wes6jrfilrm3" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Bullet_Proofing_Django_Models" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/28/Bullet_Proofing_Django_Models/" class="article-date">
  <time datetime="2018-06-28T12:08:12.000Z" itemprop="datePublished">2018-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technique/">technique</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/28/Bullet_Proofing_Django_Models/">Bullet Proofing Django Models</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://medium.com/@hakibenita/bullet-proofing-django-models-c080739be4e" target="_blank" rel="noopener">https://medium.com/@hakibenita/bullet-proofing-django-models-c080739be4e</a></p>
<p>We recently added a bank account like functionality into one of our products. During the development we encountered some textbook problems and I thought it can be a good opportunity to go over some of the patterns we use in our Django models.</p>
<p>This article was written in the order in which we usually address new problems:</p>
<ol>
<li>Define the business requirements.</li>
<li>Write down a naive implementation and model definition.</li>
<li>Challenge the solution.</li>
<li>Refine and repeat.</li>
</ol>
<p>A Bank Account<br>Business Requirements</p>
<ul>
<li>Each user can have only one account but not every user must have one.</li>
<li>The user can deposit and withdraw from the account up to a certain amount.</li>
<li>The account balance cannot be negative.</li>
<li>There is a max limit to the user’s account balance.</li>
<li>The total amount of all balances in the app cannot exceed a certain amount.</li>
<li>There must be a record for every action on the account.</li>
<li>Actions on the account can be executed by the user from either the mobile app or the web interface and by support personnel from the admin interface.</li>
</ul>
<p>Now that we have the business requirements we can start with a model definition.<br>Account Model<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'Account'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'Accounts'</span></span><br><span class="line"></span><br><span class="line">    MAX_TOTAL_BALANCES = <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">    MAX_BALANCE = <span class="number">10000</span></span><br><span class="line">    MIN_BALANCE = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    MAX_DEPOSIT = <span class="number">1000</span></span><br><span class="line">    MIN_DEPOSIT = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    MAX_WITHDRAW = <span class="number">1000</span></span><br><span class="line">    MIN_WITHDRAW = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    id = models.AutoField(</span><br><span class="line">        primary_key=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    uid = models.UUIDField(</span><br><span class="line">        unique=<span class="keyword">True</span>,</span><br><span class="line">        editable=<span class="keyword">False</span>,</span><br><span class="line">        default=uuid.uuid4,</span><br><span class="line">        verbose_name=<span class="string">'Public identifier'</span>,</span><br><span class="line">    )</span><br><span class="line">    user = models.OneToOneField(</span><br><span class="line">        settings.AUTH_USER_MODEL,</span><br><span class="line">        on_delete=models.PROTECT,</span><br><span class="line">    )</span><br><span class="line">    created = models.DateTimeField(</span><br><span class="line">        blank=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    modified = models.DateTimeField(</span><br><span class="line">        blank=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    balance = models.PositiveIntegerField(</span><br><span class="line">        verbose_name=<span class="string">'Current balance'</span>,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p>
<p>Let’s break it down:</p>
<ul>
<li>We use two unique identifiers — A private identifier which is an auto generated number (id) and a public id which is a uuid (uid). It’s a good idea to keep enumerators private — they expose important information about our data such as how many accounts we have and we don’t want that.</li>
<li>We use OneToOneField for the user. It’s like a ForeignKey but with a unique constraint. This ensures a user cannot have more than one account.</li>
<li>We set on_delete=models.PROTECT. Starting with Django 2.0 this argument will be mandatory. The default is CASCADE — when the user is deleted the related account is deleted as well. In our case this doesn’t make sense — imagine the bank “deleting your money” when you close an account. Setting on_delete=models.PROTECT will raise an IntegrityError when attempting to delete a user with an account.</li>
<li>You probably noticed that the code is very… “vertical”. This is not just because Medium has such poor support for source code — we write like that because it makes git diffs look nicer.</li>
</ul>
<p>Account Action Model</p>
<p>Now that we have an account model we can create a model to log actions made to the account:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Action</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">'Account Action'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'Account Actions'</span></span><br><span class="line"></span><br><span class="line">    ACTION_TYPE_CREATED = <span class="string">'CREATED'</span></span><br><span class="line">    ACTION_TYPE_DEPOSITED = <span class="string">'DEPOSITED'</span></span><br><span class="line">    ACTION_TYPE_WITHDRAWN = <span class="string">'WITHDRAWN'</span></span><br><span class="line">    ACTION_TYPE_CHOICES = (</span><br><span class="line">        (ACTION_TYPE_CREATED, <span class="string">'Created'</span>),</span><br><span class="line">        (ACTION_TYPE_DEPOSITED, <span class="string">'Deposited'</span>),</span><br><span class="line">        (ACTION_TYPE_WITHDRAWN, <span class="string">'Withdrawn'</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    REFERENCE_TYPE_BANK_TRANSFER = <span class="string">'BANK_TRANSFER'</span></span><br><span class="line">    REFERENCE_TYPE_CHECK = <span class="string">'CHECK'</span></span><br><span class="line">    REFERENCE_TYPE_CASH = <span class="string">'CASH'</span></span><br><span class="line">    REFERENCE_TYPE_NONE = <span class="string">'NONE'</span></span><br><span class="line">    REFERENCE_TYPE_CHOICES = (</span><br><span class="line">        (REFERENCE_TYPE_BANK_TRANSFER, <span class="string">'Bank Transfer'</span>),</span><br><span class="line">        (REFERENCE_TYPE_CHECK, <span class="string">'Check'</span>),</span><br><span class="line">        (REFERENCE_TYPE_CASH, <span class="string">'Cash'</span>),</span><br><span class="line">        (REFERENCE_TYPE_NONE, <span class="string">'None'</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    id = models.AutoField(</span><br><span class="line">        primary_key=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    user_friendly_id = models.CharField(</span><br><span class="line">        unique=<span class="keyword">True</span>,</span><br><span class="line">        editable=<span class="keyword">False</span>,</span><br><span class="line">        max_length=<span class="number">30</span>,</span><br><span class="line">    )</span><br><span class="line">    user = models.ForeignKey(</span><br><span class="line">        settings.AUTH_USER_MODEL,</span><br><span class="line">        on_delete=models.PROTECT,</span><br><span class="line">        help_text=’User who performed the action.’,</span><br><span class="line">    )</span><br><span class="line">    created = models.DateTimeField(</span><br><span class="line">        blank=<span class="keyword">True</span>,</span><br><span class="line">    )</span><br><span class="line">    account = models.ForeignKey(</span><br><span class="line">        Account,</span><br><span class="line">    )</span><br><span class="line">    type = models.CharField(</span><br><span class="line">        max_length=<span class="number">30</span>,</span><br><span class="line">        choices=ACTION_TYPE_CHOICES,</span><br><span class="line">    )</span><br><span class="line">    delta = models.IntegerField(</span><br><span class="line">        help_text=‘Balance delta.<span class="string">',</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    reference = models.TextField(</span></span><br><span class="line"><span class="string">        blank=True,</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    reference_type = models.CharField(</span></span><br><span class="line"><span class="string">        max_length=30,</span></span><br><span class="line"><span class="string">        choices=REFERENCE_TYPE_CHOICES,</span></span><br><span class="line"><span class="string">        default=REFERENCE_TYPE_NONE,</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    comment = models.TextField(</span></span><br><span class="line"><span class="string">        blank=True,</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Fields used solely for debugging purposes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    debug_balance = models.IntegerField(</span></span><br><span class="line"><span class="string">        help_text='</span>Balance after the action.<span class="string">',</span></span><br><span class="line"><span class="string">    )</span></span><br></pre></td></tr></table></figure></p>
<p>What do we have here?</p>
<ul>
<li>Each record will hold a reference to the associated balance and the delta amount. A deposit of 100$ will have a delta of 100$, and a withdrawal of 50$ will have a delta of -50$. This way we can sum the deltas of all actions made to an account and get the current balance. This is important for validating our calculated balance.</li>
<li>We follow the same pattern of adding two identifiers — a private and a public one. The difference here is that reference numbers for actions are often used by users and support personnel to identify a specific action over the phone or in emails. A uuid is not user friendly — it’s very long and it’s not something users are used to see. I found a nice implementation of user-friendly ID’s in django-invoice.</li>
<li>Two of the fields are only relevant for one type of action, deposit — reference and reference type. There are a lot of ways to tackle this issue — table inheritance and down casting, JSON fields, table polymorphism and the list of overly complicated solutions goes on. In our case we are going to use a sparse table.</li>
</ul>
<p>Note about the design: Maintaining calculated fields in the model is usually bad design. Calculated fields such as the account’s balance should be avoided whenever possible.</p>
<p>However, in our “real life“ implementation there are additional action types and thousands of actions on each account — we treat calculated attribute as an optimization. Maintaining state poses some interesting challenges and we thought it can serve the purpose of this post so we decided to present it as well.<br>Challenges<br>Multiple Platforms</p>
<p>We have three client applications we need to support:</p>
<ul>
<li>Mobile app — use an API interface to manage the account.</li>
<li>Web client — can use either an API interface (if we have some sort of SPA) or good old server side rendering with Django forms.</li>
<li>Admin interface — uses Django’s admin module with Django forms.</li>
</ul>
<p>Our motivation is to keep things DRY and self contained as possible.<br>Validation</p>
<p>We have two types of validations hiding in the business requirements:</p>
<p>Input validation such as “amount must be between X and Y”, “balance cannot exceed Z”, etc — these types of validation are well supported by Django and can usually be expressed as database constraints or django validations.</p>
<p>The second validation is a bit more complicated. We need to ensure the total amount of all balances in the entire system does not exceed a certain amount. This forces us to validate an instance against all other instances of the model.<br>Atomicity</p>
<p>Race conditions are a very common issue in distributed systems and ever more so in models that maintain state such as bank account (you can read more about race conditions in Wikipedia).</p>
<p>To illustrate the problem consider an account with a balance of 100$. The user connects from two different devices at the exact same time and issue a withdraw of 100$. Since the two actions were executed at the exact same time it is possible that both of them get a current balance of 100$. Given that both session see sufficient balance they will both get approved and update the new balance to 0$. The user withdrawn a total of 200$ and the current balance is now 0$ — we have a race condition and we are down 100$.<br>Logging / History</p>
<p>The log serves two purposes:</p>
<ul>
<li>Log and Audit — Information about historical actions — dates, amounts, users etc.</li>
<li>Check Consistency — We maintain state in the model so we want to be able to validate the calculated balance by aggregating the action deltas.</li>
</ul>
<p>The history records must be 100% immutable.<br>The Naive Implementation</p>
<p>Let’s start with a naive implementation of deposit (this is not a good implementation):<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(self, amount, deposited_by, asof)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> amount &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.MIN_DEPOSIT &lt;= amount &lt;= self.MAX_DEPOSIT:</span><br><span class="line">            <span class="keyword">raise</span> InvalidAmount(amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.balance + amount &gt; self.MAX_BALANCE:</span><br><span class="line">            <span class="keyword">raise</span> ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        total = Account.objects.aggregate(</span><br><span class="line">            total=Sum(<span class="string">'balance'</span>)</span><br><span class="line">        )[<span class="string">'total'</span>]</span><br><span class="line">        <span class="keyword">if</span> total + amount &gt; self.MAX_TOTAL_BALANCES:</span><br><span class="line">            <span class="keyword">raise</span> ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        action = self.actions.create(</span><br><span class="line">            user=deposited_by,</span><br><span class="line">            type=Action.ACTION_TYPE_DEPOSITED,</span><br><span class="line">            delta=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.balance += amount</span><br><span class="line">        self.modified = asof</span><br><span class="line"></span><br><span class="line">        self.save()</span><br></pre></td></tr></table></figure></p>
<p>And let’s add a simple endpoint for it using DRF @api_view:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api.py</span></span><br><span class="line"></span><br><span class="line">…</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> transaction</span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view('POST')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        amount = int(request.data[<span class="string">'amount'</span>])</span><br><span class="line">    <span class="keyword">except</span> (KeyError, ValueError):</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            account = (</span><br><span class="line">                Account.objects</span><br><span class="line">                .select_for_update()</span><br><span class="line">                .get(user=request.user)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> Account.DoesNotExist:</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            account.deposit(</span><br><span class="line">                amount=amount,</span><br><span class="line">                deposited_by=request.user,</span><br><span class="line">                asof=timezone.now(),</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> (ExceedsLimit, InvalidAmount):</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_200_OK)</span><br></pre></td></tr></table></figure></p>
<p>So what is the problem?</p>
<ul>
<li><p>Locking the account — An instance cannot lock itself because it had already been fetched. We gave up control over the locking and fetching so we have to trust the caller to properly obtain a lock — this is very bad design. Don’t take my word for it, let’s take a glimpse at Django’s design philosophy:</p>
</li>
<li><p>Loose coupling<br>  A fundamental goal of Django’s stack is loose coupling and tight cohesion. The various layers of the framework shouldn’t “know” about each other unless absolutely necessary.</p>
</li>
</ul>
<p>So is it really the business of our API, forms and django admin to fetch the account for us and obtain a proper lock? I think not.</p>
<ol>
<li>Validation — The account has to validate itself against all other accounts — this just feels awkward.<br>A Better Approach</li>
</ol>
<p>We need to hook into the process before the account is fetched (to obtain a lock) and in a place where it makes sense to validate and process more than one account.</p>
<p>Let’s start with a function to create an Action instance and write it as a classmethod:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Action</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    …</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        cls,</span></span></span><br><span class="line"><span class="function"><span class="params">        user,</span></span></span><br><span class="line"><span class="function"><span class="params">        account,</span></span></span><br><span class="line"><span class="function"><span class="params">        type,</span></span></span><br><span class="line"><span class="function"><span class="params">        delta,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof,</span></span></span><br><span class="line"><span class="function"><span class="params">        reference=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        reference_type=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        comment=None,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        <span class="string">"""Create Action.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        user (User):</span></span><br><span class="line"><span class="string">            User who executed the action.</span></span><br><span class="line"><span class="string">        account (Account):</span></span><br><span class="line"><span class="string">            Account the action executed on.</span></span><br><span class="line"><span class="string">        type (str, one of Action.ACTION_TYPE_*):</span></span><br><span class="line"><span class="string">            Type of action.</span></span><br><span class="line"><span class="string">        delta (int):</span></span><br><span class="line"><span class="string">            Change in balance.</span></span><br><span class="line"><span class="string">        asof (datetime.datetime):</span></span><br><span class="line"><span class="string">            When was the action executed.</span></span><br><span class="line"><span class="string">        reference (str or None):</span></span><br><span class="line"><span class="string">            Reference number when appropriate.</span></span><br><span class="line"><span class="string">        reference_type(str or None):</span></span><br><span class="line"><span class="string">            Type of reference.</span></span><br><span class="line"><span class="string">            Defaults to "NONE".</span></span><br><span class="line"><span class="string">        comment (str or None):</span></span><br><span class="line"><span class="string">            Optional comment on the action.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ValidationError</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns (Action)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">assert</span> asof <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type == cls.ACTION_TYPE_DEPOSITED <span class="keyword">and</span></span><br><span class="line">            reference_type <span class="keyword">is</span> <span class="keyword">None</span>):</span><br><span class="line">            <span class="keyword">raise</span> errors.ValidationError(&#123;</span><br><span class="line">                <span class="string">'reference_type’: ‘required for deposit.'</span>,  </span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> reference_type <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            reference_type = cls.REFERENCE_TYPE_NONE</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Don't store null in text field.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> reference <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            reference = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> comment <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            comment = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        user_friendly_id = generate_user_friendly_id()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls.objects.create(</span><br><span class="line">            user_friendly_id=user_friendly_id,</span><br><span class="line">            created=asof,</span><br><span class="line">            user=user,</span><br><span class="line">            account=account,</span><br><span class="line">            type=type,</span><br><span class="line">            delta=delta,</span><br><span class="line">            reference=reference,</span><br><span class="line">            reference_type=reference_type,</span><br><span class="line">            comment=comment,</span><br><span class="line">            debug_balance=account.balance,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure></p>
<p>What do we have here:</p>
<ul>
<li>We used a classmethod that accepts all necessary data to validate and create the new instance. By <em>not</em> using the default manager’s create function (Action.objects.create) we encapsulate all the business logic in the creation process.</li>
<li>We easily introduced custom validation and raise proper ValidationError.</li>
<li>We accept the creation time as an argument. That might seem a bit strange at first glance — why not use the built in auto_time_add? For starters It’s much easier to test with predictable values. Second, as we are going to see in just a bit, we can make sure the modified time of the account is exactly the same as the action created time.</li>
</ul>
<p>Before moving over to the implementation of the account methods let’s define custom exceptions for our Account module:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># errors.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Error</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExceedsLimit</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvalidAmount</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, amount)</span>:</span></span><br><span class="line">        self.amount = amount</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(str)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Invalid Amount: &#123;&#125;'</span>.format(amount)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InsufficientFunds</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, balance, amount)</span>:</span></span><br><span class="line">        self.balance = balance</span><br><span class="line">        self.amount = amount</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'amount: &#123;&#125;, current balance: &#123;&#125;'</span>.format(</span><br><span class="line">                self.amount, self.balance)</span><br></pre></td></tr></table></figure></p>
<p>We define a base Error class that inherits from Exception. This is something we found very useful and we use it a lot. A base error class allows us to catch all errors coming from a certain module:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> account.errors <span class="keyword">import</span> Error <span class="keyword">as</span> AccountError</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   <span class="comment"># action on account</span></span><br><span class="line"><span class="keyword">except</span> AccountError:</span><br><span class="line">   <span class="comment"># Handle all errors from account</span></span><br></pre></td></tr></table></figure></p>
<p>A similar pattern can be found in the popular requests package.</p>
<p>Let’s implement the method to create a new Account:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls, user, created_by, asof)</span>:</span></span><br><span class="line">        <span class="string">"""Create account.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        user (User):</span></span><br><span class="line"><span class="string">            Owner of the account.</span></span><br><span class="line"><span class="string">        created_by (User):</span></span><br><span class="line"><span class="string">            User that created the account.</span></span><br><span class="line"><span class="string">        asof (datetime.datetime):</span></span><br><span class="line"><span class="string">            Time of creation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns (tuple):</span></span><br><span class="line"><span class="string">            [0] Account</span></span><br><span class="line"><span class="string">            [1] Action</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">            account = cls.objects.create(</span><br><span class="line">                user=user,</span><br><span class="line">                created=asof,</span><br><span class="line">                modified=asof,</span><br><span class="line">                balance=<span class="number">0</span>,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            action = Action.create(</span><br><span class="line">                user=created_by,</span><br><span class="line">                account=account,</span><br><span class="line">                type=Action.ACTION_TYPE_CREATED,</span><br><span class="line">                delta=<span class="number">0</span>,</span><br><span class="line">                asof=asof,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> account, action</span><br></pre></td></tr></table></figure></p>
<p>Pretty straight forward — create the instance, create the action and return them both.</p>
<p>Notice how we accept asof here as well — modified, created and the action creation time are all equal — you cant do that with auto_add and auto_add_now.</p>
<p>Now to the business logic:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    cls,</span></span></span><br><span class="line"><span class="function"><span class="params">    uid,</span></span></span><br><span class="line"><span class="function"><span class="params">    deposited_by,</span></span></span><br><span class="line"><span class="function"><span class="params">    amount,</span></span></span><br><span class="line"><span class="function"><span class="params">    asof,</span></span></span><br><span class="line"><span class="function"><span class="params">    comment=None,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="string">"""Deposit to account.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    uid (uuid.UUID):</span></span><br><span class="line"><span class="string">        Account public identifier.</span></span><br><span class="line"><span class="string">    deposited_by (User):</span></span><br><span class="line"><span class="string">        Deposited by.</span></span><br><span class="line"><span class="string">    amount (positive int):</span></span><br><span class="line"><span class="string">        Amount to deposit.</span></span><br><span class="line"><span class="string">    asof (datetime.datetime):</span></span><br><span class="line"><span class="string">        Time of deposit.</span></span><br><span class="line"><span class="string">    comment(str or None):</span></span><br><span class="line"><span class="string">       Optional comment.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises</span></span><br><span class="line"><span class="string">        Account.DoesNotExist</span></span><br><span class="line"><span class="string">        InvalidAmount</span></span><br><span class="line"><span class="string">        ExceedsLimit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns (tuple):</span></span><br><span class="line"><span class="string">        [0] (Account) Updated account instance.</span></span><br><span class="line"><span class="string">        [0] (Action) Deposit action.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">assert</span> amount &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        account = cls.objects.select_for_update().get(uid=uid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (cls.MIN_DEPOSIT &lt;= amount &lt;= cls.MAX_DEPOSIT):</span><br><span class="line">            <span class="keyword">raise</span> errors.InvalidAmount(amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> account.balance + amount &gt; cls.MAX_BALANCE:</span><br><span class="line">            <span class="keyword">raise</span> errors.ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        total = cls.objects.aggregate(total=Sum(<span class="string">'balance'</span>))[<span class="string">'total'</span>]</span><br><span class="line">        <span class="keyword">if</span> total + amount &gt; cls.MAX_TOTAL_BALANCES:</span><br><span class="line">            <span class="keyword">raise</span> errors.ExceedsLimit()</span><br><span class="line"></span><br><span class="line">        account.balance += amount</span><br><span class="line">        account.modified = asof</span><br><span class="line"></span><br><span class="line">        account.save(update_fields=[</span><br><span class="line">            <span class="string">'balance'</span>,</span><br><span class="line">            <span class="string">'modified'</span>,</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        action = Action.create(</span><br><span class="line">            user=deposited_by,</span><br><span class="line">            account=account,</span><br><span class="line">            type=Action.ACTION_TYPE_DEPOSITED,</span><br><span class="line">            delta=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> account, action</span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">withdraw</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    cls,</span></span></span><br><span class="line"><span class="function"><span class="params">    uid,</span></span></span><br><span class="line"><span class="function"><span class="params">    withdrawn_by,</span></span></span><br><span class="line"><span class="function"><span class="params">    amount,</span></span></span><br><span class="line"><span class="function"><span class="params">    asof</span></span></span><br><span class="line"><span class="function"><span class="params">    comment=None,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="string">"""Withdraw from account.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    uid (uuid.UUID):</span></span><br><span class="line"><span class="string">        Account public identifier.</span></span><br><span class="line"><span class="string">    withdrawn_by (User):</span></span><br><span class="line"><span class="string">        The withdrawing user.</span></span><br><span class="line"><span class="string">    amount (positive int):</span></span><br><span class="line"><span class="string">        Amount to withdraw.</span></span><br><span class="line"><span class="string">    asof (datetime.datetime):</span></span><br><span class="line"><span class="string">        Time of withdraw.</span></span><br><span class="line"><span class="string">    comment (str or None):</span></span><br><span class="line"><span class="string">       Optional comment.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        Account.DoesNotExist</span></span><br><span class="line"><span class="string">        InvalidAmount</span></span><br><span class="line"><span class="string">        InsuficientFunds</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns (tuple):</span></span><br><span class="line"><span class="string">        [0] (Account) Updated account instance.</span></span><br><span class="line"><span class="string">        [0] (Action) Withdraw action.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">assert</span> amount &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        account = cls.objects.select_for_update().get(uid=uid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (cls.MIN_WITHDRAW &lt;= amount &lt;= cls.MAX_WITHDRAW):</span><br><span class="line">            <span class="keyword">raise</span> InvalidAmount(amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> account.balance - amount &lt; cls.MIN_BALANCE:</span><br><span class="line">            <span class="keyword">raise</span> InsufficientFunds(amount, account.balance)</span><br><span class="line"></span><br><span class="line">        account.balance -= amount</span><br><span class="line">        account.modified = asof</span><br><span class="line"></span><br><span class="line">        account.save(update_fields=[</span><br><span class="line">            <span class="string">'balance'</span>,</span><br><span class="line">            <span class="string">'modified'</span>,</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        action = Action.create(</span><br><span class="line">            user=withdrawn_by,</span><br><span class="line">            account=account,</span><br><span class="line">            type=Action.ACTION_TYPE_WITHDRAWN,</span><br><span class="line">            delta=-amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> account, action</span><br></pre></td></tr></table></figure></p>
<p>We can start to see the pattern here:</p>
<ul>
<li>Acquire a lock on the account using select_for_update. This will lock the account row in the database and make sure no one can update the account instance until the transaction is completed (either committed or rolled-back).</li>
<li>Perform validation checks and raise proper exceptions — raising an exception will cause the transaction to rollback.<br>  If all the validations passed update the state (current balance), set the modification time, save the instance and create the log (action).</li>
</ul>
<p>So how does the model hold up to our challenges?</p>
<ul>
<li>Multiple Platforms and Validation — We encapsulated all of our business logic including input and system wide validation inside the model method so consumers such as API, admin action or forms only need to handle exceptions and serialization / UI.</li>
<li>Atomicity — Each method obtains its own lock so there is no risk of race condition.<br>  Logging / History — We created an action model and made sure each function registers the proper action.</li>
</ul>
<p>Profit!<br>Testing</p>
<p>Our app will be incomplete without proper tests. I previously wrote about class based testings — we are going to take a slightly different approach but still have a base class with utility functions:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/common.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestAccountBase</span>:</span></span><br><span class="line"></span><br><span class="line">    DEFAULT = object()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default</span><span class="params">(value, default_value)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> default_value <span class="keyword">if</span> value <span class="keyword">is</span> cls.DEFAULT <span class="keyword">else</span> value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUpTestData</span><span class="params">(cls)</span>:</span></span><br><span class="line">        super().setUpTestData()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Set up some default values</span></span><br><span class="line">        cls.admin = User.objects.create_superuser(</span><br><span class="line">            <span class="string">'Admin'</span>,</span><br><span class="line">            <span class="string">'admin'</span>,</span><br><span class="line">            <span class="string">'admin@testing.test'</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        cls.user_A = User.objects.create_user(</span><br><span class="line">            <span class="string">'user_A'</span>,</span><br><span class="line">            <span class="string">'user_A'</span>,</span><br><span class="line">            <span class="string">'A@testing.test'</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        cls,</span></span></span><br><span class="line"><span class="function"><span class="params">        user=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        created_by=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof=DEFAULT</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        user = cls.default(user, cls.user_A)</span><br><span class="line">        created_by = cls.default(created_by, cls.admin)</span><br><span class="line">        asof = cls.default(asof, timezone.now())</span><br><span class="line"></span><br><span class="line">        account, action = Account.create(user, created_by, asof)</span><br><span class="line">        <span class="keyword">return</span> cls.account, action</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deposit</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        amount,</span></span></span><br><span class="line"><span class="function"><span class="params">        account=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        deposited_by=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        comment=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        account = self.default(account, self.account)</span><br><span class="line">        deposited_by = self.default(deposited_by, self.admin)</span><br><span class="line">        asof = self.default(asof, timezone.now())</span><br><span class="line">        comment = self.default(comment, ‘deposit comment’)</span><br><span class="line"></span><br><span class="line">        self.account, action = Account.deposit(</span><br><span class="line">            uid=account.uid,</span><br><span class="line">            deposited_by=deposited_by,</span><br><span class="line">            amount=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.assertEqual(action.type, Action.ACTION_TYPE_DEPOSITED)</span><br><span class="line">        self.assertIsNotNone(action.user_friendly_id)</span><br><span class="line">        self.assertEqual(action.created, asof)</span><br><span class="line">        self.assertEqual(action.delta, amount)</span><br><span class="line">        self.assertEqual(action.user, deposited_by)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> action</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">withdraw</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        amount,</span></span></span><br><span class="line"><span class="function"><span class="params">        account=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        withdrawn_by=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        asof=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        comment=DEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        account = self.default(account, self.account)</span><br><span class="line">        withdrawn_by = self.default(withdrawn_by, self.admin)</span><br><span class="line">        asof = self.default(asof, timezone.now())</span><br><span class="line">        comment = self.default(comment, ‘withdraw comment’)</span><br><span class="line"></span><br><span class="line">        self.account, action = Account.withdraw(</span><br><span class="line">            uid=account.uid,</span><br><span class="line">            withdrawn_by=withdrawn_by,</span><br><span class="line">            amount=amount,</span><br><span class="line">            asof=asof,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.assertEqual(action.type, Action.ACTION_TYPE_WITHDRAWN)</span><br><span class="line">        self.assertIsNotNone(action.user_friendly_id)</span><br><span class="line">        self.assertEqual(action.created, asof)</span><br><span class="line">        self.assertEqual(action.delta, amount)</span><br><span class="line">        self.assertEqual(action.user, withdrawn_by)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> action</span><br></pre></td></tr></table></figure></p>
<p>To make testing easier to write we use utility functions to reduce the boilerplate of specifying the user, the account etc each time by providing default values and operating on self.account.</p>
<p>Lets use our base class to write some tests:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/test_account.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> mock</span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .common <span class="keyword">import</span> TestAccoutBase</span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> Account, Action</span><br><span class="line"><span class="keyword">from</span> ..errors <span class="keyword">import</span> (</span><br><span class="line">    InvalidAmount,</span><br><span class="line">    ExceedsLimit,</span><br><span class="line">    InsuficientFunds,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestAccount</span><span class="params">(TestAccountBase, TestCase)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.account, _ = cls.create()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_start_with_zero_balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_deposit</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.deposit(<span class="number">100</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">100</span>)</span><br><span class="line">        self.deposit(<span class="number">150</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">250</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_to_deposit_less_than_minimum</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(InvalidAmount):</span><br><span class="line">            self.deposit(Account.MIN_DEPOSIT - <span class="number">1</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_to_deposit_more_than_maximum</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(InvalidAmount):</span><br><span class="line">            self.deposit(Account.MAX_DEPOSIT + <span class="number">1</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_BALANCE', 500)</span></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_DEPOSIT', 502)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_to_deposit_more_than_max_balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(ExceedsLimit):</span><br><span class="line">            self.deposit(<span class="number">501</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_BALANCE', 500)</span></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_DEPOSIT', 500)</span></span><br><span class="line"><span class="meta">    @mock.patch('account.models.Account.MAX_TOTAL_BALANCES', 600)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_when_exceed_max_total_balances</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Exceed max total balances for the same account</span></span><br><span class="line"></span><br><span class="line">        self.deposit(<span class="number">500</span>)</span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(ExceedsLimit):</span><br><span class="line">            self.deposit(<span class="number">500</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Exceed max total balances in other account</span></span><br><span class="line"></span><br><span class="line">        other_user = User.objects.create_user(<span class="string">'foo'</span>, <span class="string">'bar'</span>, <span class="string">'baz'</span>)</span><br><span class="line">        other_account = self.create(user=other_user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(ExceedsLimit):</span><br><span class="line">            self.deposit(<span class="number">200</span>, account=other_account)</span><br><span class="line">        self.assertEqual(other_account.balance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_withdraw</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.deposit(<span class="number">100</span>)</span><br><span class="line">        self.withdraw(<span class="number">50</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">50</span>)</span><br><span class="line">        self.withdraw(<span class="number">30</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_should_fail_when_insufficient_funds</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.deposit(<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(InsufficientFunds):</span><br><span class="line">            self.withdraw(<span class="number">101</span>)</span><br><span class="line">        self.assertEqual(self.account.balance, <span class="number">100</span>)</span><br></pre></td></tr></table></figure></p>
<p>Final Words</p>
<p>The classmethod approach has proved itself in our development for quite some time now. We found that it provides the necessary flexibility, readability and testability with very little overhead.</p>
<p>In this article we presented two common issues we encounter frequently — validation and concurrency. This method can be extended to handle access control (permissions) and caching (we have total control over the fetch, remember?), performance optimization (use select_related and update_fields…), audit and monitoring and additional business logic.</p>
<p>We usually support several interfaces for each model — admin interface for support, API for mobile and SPA clients, and a dashboard. Encapsulating the business logic inside the model reduced the amount of code duplication and required tests which leads to overall quality code that is easy to maintain.</p>
<p>In a follow up post I (might) present the admin interface for this model with some neat tricks (such as custom actions, intermediate pages etc) and possibly an RPC implementation using DRF to interact with the account as an API.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/28/Bullet_Proofing_Django_Models/" data-id="cjj7xy5gq0001wes6x0i0bg0f" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-阿里云SLB显示用户真实IP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/21/阿里云SLB显示用户真实IP/" class="article-date">
  <time datetime="2018-05-21T12:28:41.000Z" itemprop="datePublished">2018-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technique/">technique</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/21/阿里云SLB显示用户真实IP/">阿里云SLB显示用户真实IP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>其实解决方法挺简单的，配合Nginx的Realip模块就行，主要是配置问题，我之前折腾CDN的时候就搞过，不过来源IP各家都有所不同，所以这边记录下吧，辣鸡阿里云自己的文档里都不写，简直智障。</p>
<ul>
<li>首先确保你的Nginx安装了realip模块，nginx -V然后看看有没有http_realip_module就行，没有的话需要重新编译安装，在./configure后面添加–with-http_realip_module 然后一顿操作就行</li>
<li>修改nginx.conf配置文件，在http区块部分添加如下内容（如果你还是不知道是哪部分，那就找一堆fastcgi那边，在最后一行fastcgi下面添加）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set_real_ip_from <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>;</span><br><span class="line">set_real_ip_from <span class="number">10.49</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>;</span><br><span class="line">set_real_ip_from <span class="number">10.158</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>;</span><br><span class="line">set_real_ip_from <span class="number">10.159</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>;</span><br><span class="line">set_real_ip_from <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">10</span>;</span><br><span class="line">real_ip_header X-Forwarded-For;</span><br><span class="line">real_ip_recursive on;</span><br></pre></td></tr></table></figure>
<p>然后重启下nginx就行，这个对lnmpa也行，在nginx里面会显示真实ip，在apache那儿会显示127.0.0.1+真实ip<br>直接使用apache处理的情况下需要安装mod_rpaf这个模块，我就不多提了，网上搜下就有然后重启下nginx就行，这个对lnmpa也行，在nginx里面会显示真实ip，在apache那儿会显示127.0.0.1+真实ip<br>直接使用apache处理的情况下需要安装mod_rpaf这个模块，我就不多提了，网上搜下就有</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/21/阿里云SLB显示用户真实IP/" data-id="cjj7xy5hq0028wes6s2lt4amq" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Nginx获取真实IP方案" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/21/Nginx获取真实IP方案/" class="article-date">
  <time datetime="2018-05-21T12:27:09.000Z" itemprop="datePublished">2018-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technique/">technique</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/21/Nginx获取真实IP方案/">Nginx获取真实IP方案</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="问题根源："><a href="#问题根源：" class="headerlink" title="问题根源："></a>问题根源：</h3><p>基于七层的负载均衡系统，获取IP的原理都是通过XRI和XFF进行处理，从中选出“正常情况下”的源头IP，然而这两个Header都是普通的HTTP头，任何代理程序都可以轻易修改伪造它们，使得获取IP的逻辑失效。</p>
<h3 id="解决依据："><a href="#解决依据：" class="headerlink" title="解决依据："></a>解决依据：</h3><p>TCP协议需要建立真实的网络链路，因此其信息可以认为是真实可靠难以伪造的。根据阿里SLB文档中获取真实IP的方法（<a href="https://help.aliyun.com/document_detail/slb/best-practice/get-real-ipaddress.html）得知，如果采用四层负载均衡，则SLB的后端系统可直接通过" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/slb/best-practice/get-real-ipaddress.html）得知，如果采用四层负载均衡，则SLB的后端系统可直接通过</a> remote address 获取到IP，如果采用七层负载均衡，后续系统需配合 http_realip_module 使用。</p>
<h3 id="设置步骤："><a href="#设置步骤：" class="headerlink" title="设置步骤："></a>设置步骤：</h3><p>1、在阿里SLB中将负载均衡模式设置为四层，并且打开获取真实IP的选项（默认打开）；<br>2、在SLB后端的转发 nginx 中使用 $remote_addr 参数填写 XRI 和 XFF；<br>3、在应用中即可可通过 XRI 或 XFF 获取真实 IP；</p>
<h3 id="试验环境："><a href="#试验环境：" class="headerlink" title="试验环境："></a>试验环境：</h3><p>客户端：Chrome ＋ Postman<br>本地模拟：本地 nginx ＋ 测试环境 nginx ＋ 测试环境 app<br>四层负载均衡：阿里 SLB ＋ 测试环境 nginx ＋ 测试环境 app<br>七层负载均衡：阿里 SLB ＋ release nginx ＋ release app</p>
<h3 id="试验步骤："><a href="#试验步骤：" class="headerlink" title="试验步骤："></a>试验步骤：</h3><ol>
<li>在测试环境 customer 应用中部署 test.jsp，内容为获取 request 信息；</li>
<li><p>双 nginx 模拟<br> a. 在测试环境 nginx 中设置 XFF 规则如下：</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure>
</code></pre><p> b. 在本地 nginx 中设置负载均衡到测试环境 nginx 地址，XFF 规则同上；<br> c. 使用 Postman 直接发送请求：可以发现XFF的第一个IP是正确的地址（由于本试验中本地 nginx 是系统的一部分，所以127.0.0.1算正确IP）；<br> d. 在请求中加入伪造的 XFF：发现此时获取到的 XFF 已经被污染。</p>
</li>
<li>四层SLB测试<br> a. 将测试环境 nginx 中的 XFF 规则设置为： proxy_set_header X-Forwarded-For $remote_addr;<br> b. 正常发送请求 发现获取了正确的 IP；<br> c. 伪造 XFF 请求：发现依然可以获取到正确的 IP；</li>
<li><p>七层SLB + http_realip_module 模块测试<br> a. 将 release 环境 nginx 相关配置修改为（其中100.97.0.0/16为SLB所在网段）：</p>
<pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_real_ip_from <span class="number">100.97</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>;</span><br><span class="line">real_ip_header X-Forwarded-For;</span><br><span class="line">real_ip_recursive on;</span><br></pre></td></tr></table></figure>
</code></pre><p> b. 伪造XFF请求：可以发现：HTTP头中多了一个 remoteip 的字段，其值始终为正确的客户 IP；同时，XFF 字段保留了所有代理链路信息（包括伪造的部分）。</p>
</li>
</ol>
<h3 id="试验总结："><a href="#试验总结：" class="headerlink" title="试验总结："></a>试验总结：</h3><p>1、无论哪种方案其实核心原理大同小异，都是利用四层TCP的连接信息获取实际IP参数，区别只在于：获取到的这个IP在何时、用何种方式传递到后面系统，以及后面系统如何接收该参数。<br>2、双 nginx 只是为了在可控环境模拟 HTTP IP 欺骗的原理；<br>3、四层 SLB 负载均衡方案思路是在整个系统入口（即SLB的四层处）覆盖掉原始的 XRI 或 XFF，在系统的后面部分便可充分信任这些参数；<br>4、七层 SLB 负载均衡方案思路是把系统入口处拿到的真实IP放在独立的 remoteip 参数中（当然如果需要也可在后续nginx中用该参数覆写 XRI 或 XFF，和上一个方案相同）；</p>
<h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><p>阿里云SLB获取真实IP的配置方法：<br><a href="https://help.aliyun.com/document_detail/slb/best-practice/get-real-ipaddress.html" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/slb/best-practice/get-real-ipaddress.html</a><br>http_realip_module官方文档：<br><a href="http://nginx.org/en/docs/http/ngx_http_realip_module.html" target="_blank" rel="noopener">http://nginx.org/en/docs/http/ngx_http_realip_module.html</a><br>http_realip_module实现代码：<br><a href="https://github.com/nginx/nginx/blob/master/src/http/modules/ngx_http_realip_module.c" target="_blank" rel="noopener">https://github.com/nginx/nginx/blob/master/src/http/modules/ngx_http_realip_module.c</a><br>阿里SLB原理：<br><a href="http://blog.aliyun.com/149" target="_blank" rel="noopener">http://blog.aliyun.com/149</a><br>SLB官负载均衡配置：<br><a href="https://help.aliyun.com/document_detail/slb/slb-use-guide/slb-listen-config.html" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/slb/slb-use-guide/slb-listen-config.html</a></p>
<h3 id="测试用页面代码："><a href="#测试用页面代码：" class="headerlink" title="测试用页面代码："></a>测试用页面代码：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page contentType=<span class="string">"text/html"</span> pageEncoding=<span class="string">"GBK"</span>%&gt;</span><br><span class="line">&lt;%@page <span class="keyword">import</span>=<span class="string">"java.util.*"</span>%&gt;&lt;!--使用Enumeration导入此包--&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;接收全部请求参数的名称及对应的内容&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    Enumeration enu=request.getHeaderNames();//取得全部头信息</span><br><span class="line">    while(enu.hasMoreElements())&#123;//以此取出头信息</span><br><span class="line">        String headerName=(String)enu.nextElement();</span><br><span class="line">        String headerValue=request.getHeader(headerName);//取出头信息内容</span><br><span class="line">%&gt;</span><br><span class="line">        &lt;h5&gt;&lt;%=headerName%&gt;&lt;font color="red"&gt;--&gt;&lt;/font&gt;</span><br><span class="line">        &lt;font color="blue"&gt;&lt;%=headerValue%&gt;&lt;/font&gt;&lt;/h5&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/21/Nginx获取真实IP方案/" data-id="cjj7xy5gv0005wes6y9294d08" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-一些牛人" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/21/一些牛人/" class="article-date">
  <time datetime="2018-02-21T14:15:44.000Z" itemprop="datePublished">2018-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/economics/">economics</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/21/一些牛人/">一些牛人</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">陈元</span><br><span class="line">刘鹤</span><br><span class="line">朱云来</span><br><span class="line">靳海涛</span><br><span class="line">吴晓灵</span><br><span class="line">周小川</span><br><span class="line">祁斌</span><br><span class="line">华生</span><br><span class="line">李青原</span><br><span class="line">高西庆</span><br><span class="line">钱颖一</span><br><span class="line">国家税务总局原副局长、联办财经研究院院长、中国经济50人论坛学术委员会成员 许善达</span><br><span class="line">顾南九</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">邱国鹭</span><br><span class="line">高瓴资本张磊</span><br><span class="line">窦玉明</span><br><span class="line">杨爱斌</span><br><span class="line">钟朋荣</span><br><span class="line">中金梁红</span><br><span class="line">史正富</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">刘央		 --- 投资文化领域, 华数传媒 华谊兄弟 光线传媒</span><br><span class="line">史玉柱		--- 保险,民生银行</span><br><span class="line">郭广昌		--- 重点是保险领域</span><br><span class="line">李驰</span><br><span class="line">许小年</span><br><span class="line">樊纲</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">兴业全球杨东</span><br><span class="line">兴业吕琪</span><br></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安红军</span><br><span class="line">水晶苍蝇拍</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安红军</span><br><span class="line">水晶苍蝇拍</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/21/一些牛人/" data-id="cjj7xy5h3000kwes64jklbyt4" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-不畏浮云遮望眼：黄江南关于十九大的四个解读和十个判断" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/21/不畏浮云遮望眼：黄江南关于十九大的四个解读和十个判断/" class="article-date">
  <time datetime="2018-02-21T14:03:10.000Z" itemprop="datePublished">2018-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/economics/">economics</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/21/不畏浮云遮望眼：黄江南关于十九大的四个解读和十个判断/">不畏浮云遮望眼：黄江南关于十九大的四个解读和十个判断</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>2017年11月11日，盈泰财富云三周年庆典上，素有改革四君子之称的黄江南先生向现场300余位嘉宾呈现了题为《四个解读、十个判断》的演讲，以下是演讲全文。</p>
<p>各位朋友，下午好！</p>
<p>私募云是我的老朋友，我跟私募云认识将近三年，大家也知道我在研究观念经济学，我今天尝试一下用观念经济学的理论来解读十九大报告，用观念经济学的理论对今后5年到10年中国的发展走向和几个重大问题作出一个研判或者叫预测。我的发言主题叫“四个解读、十个判断”。</p>
<p>十九大报告有四个问题是我们特别关注的。</p>
<ul>
<li><p>第一个，我国进入了新时代，什么是新时代？</p>
</li>
<li><p>第二个提出我国社会的基本矛盾发生了基本变化，为什么中央提出来基本矛盾发生了变化，它的社会根据是什么？</p>
</li>
<li><p>第三个不忘初心，习主席反复提出不忘初心，那么习主席和共产党的初心是什么？</p>
</li>
<li><p>第四个提出中国式的社会主义，什么是中国式的社会主义？四个基本问题解读完成，我将做出中国今后5到10年中国可能发生的10件大事的预测。</p>
</li>
</ul>
<h2 id="解读之一，新时代就是智能时代和观念时代"><a href="#解读之一，新时代就是智能时代和观念时代" class="headerlink" title="解读之一，新时代就是智能时代和观念时代"></a>解读之一，新时代就是智能时代和观念时代</h2><p>我先讲一下新时代，新时代我党已经不是第一次提了，我们记得80年代初期一个老人在南方画了一个圈带领我们进入了新时代，这次为什么又要重提新时代？上一个新时代应该说是从农业社会向工业社会迈进的一个冲锋号，80年代中国真正开始了中国工业革命，80年代以前中国基本是农业社会，80年代提出新时代有经济理论根据的。</p>
<p>经过将近40年的改革开放，我们国家现在应该说基本上完成了工业革命的任务，工业革命是什么呢？工业革命是制造业革命，就是解决数量问题，解决有无的问题，解决吃饱穿好有房子住的问题，这些问题40年基本解决了，还解决了全世界很多地方人民群众的需要，我们顺利了完成了工业革命的任务，那么今后往哪发展呢？</p>
<p>不仅我们迷茫，各界都迷茫，我去欧洲很多次，欧洲一片迷茫。在欧洲和美国，从事农业的人口不到5%，从事工业的人口加上农业人口加矿业人口不到30%，70%以上的人从事智能生产；今年中国的工业、农业、矿业已经占GDP的比重低于50%，也就是说近期我们跨过了一个分界线，跨过了一个GDP和人口不是依赖工业产品和工业生产这样的GDP的经济，就是人类社会重大变化，或者说工业社会已经过去了，智能社会、观念社会已经到来。</p>
<p>我们国家提出新时代就是这个含义，但是并不是每个人都理解新时代，首先特朗普先生没有明白新时代，他还在恢复制造业，我们国家领导人迎接新经济，一个领导的思想眼光多有远，决定这个国家这个地区发展多远，我们国家领导人看到新时代以后，新时代不仅仅经济的转折，也是一个社会和经济的转折，因此习近平主席提出来要建立新的治理方式，这个治理方式是前人没有过的，既不是以前的东方也不是今天西方的社会治理方式，是什么？还在创造，估计我们习主席也在和我们一起在研究、探索，但是我们中国将第一个拿出适应观念社会的治理方式，所以说这个虽然仅仅是一个提法，但是他将给整个国家的经济发展和社会发展提供完全不同的方向。</p>
<h2 id="解读之二：基本矛盾变化的背后隐含着观念生产的基本规律"><a href="#解读之二：基本矛盾变化的背后隐含着观念生产的基本规律" class="headerlink" title="解读之二：基本矛盾变化的背后隐含着观念生产的基本规律"></a>解读之二：基本矛盾变化的背后隐含着观念生产的基本规律</h2><p>第二个，社会基本矛盾发生变化。我们知道以前的基本矛盾工人阶级和资本家之间的阶级斗争。随着社会的发展工人已经不是主要阶级了，工人阶级逐步走向萎缩消亡的过程中，再说工人阶级和资本家的斗争就不合时宜了，因为这个社会的主体不是产业工人了，这个社会已经没有不是资本家工人斗争。</p>
<p>但是有没有矛盾呢？有，没有阶级差别但是有财富差别。因为观念产品可以没有成本的复制，也就是我们的微信可以没有成本的让大家使用，可以复制，思想是可以复制的、因此在观念生产的过程中财富的增长速度比以往疯狂的增长起来，以前几代人积累的财富现在5年、10年就能积累出来，这造成了财富差别的加大。</p>
<p>而且告诉大家今后的财富差距会越来越大，观念经济本身的自然法则，一定会越来越大。但是财富的差别不是阶级的差别，也就是说马化腾发财了，他给你提供了廉价的产品，他不是剥削来的，没有办法用阶级斗争解决这些矛盾，但是不能不解决，不解决就会出现动荡，因此需要新的治理方式新的社会矛盾，这个社会矛盾为什么转变呢？</p>
<p>因为我们不再存在工业社会了，所以工业社会的资本家和工人的矛盾已经非常非常次要了，贫困的差距由人们的自然天赋造成的，美国的篮球运动员科比挣2000万，其他挣50万，因为他投篮准，明星为什么赚钱呢？大家愿意看，这是天赋，天赋造成的差距不是阶级斗争的差距，天赋造成的差距是一个长期的问题，包括像我们私募云，大家是投资人，私募云是不是剥削了大家呢？观念生产者，靠财富管理的头脑，你们大家把钱给他，是因为他能够给你们挣更多的钱，所以资本主义社会是你多我少的社会，你多了我少了，我们观念社会你挣的更多了我也更多了，是共享的结果。这里面社会基本矛盾转变是由于社会生产方式发生了变化，所以社会的矛盾也发生了变化。</p>
<h2 id="解读之三：中国共产党的初心就是为人民服务"><a href="#解读之三：中国共产党的初心就是为人民服务" class="headerlink" title="解读之三：中国共产党的初心就是为人民服务"></a>解读之三：中国共产党的初心就是为人民服务</h2><p>第三个初心？什么叫初心呢？马克思经济学已经过时了，他的思想没有过时，马克思初心解放全人类，全世界进入资本主义时代，所以马克思主义的初心解放全人类，现在还没有变，也不会错，我们中国的初心是毛主席提的为人民服务，这就是我们政权、政党和习主席的初心。</p>
<p>为人民服务和马克思解放全人类他们很多地方相同的，但是为人民服务比解放全人类更近了一步，解放全人类被解放，从资本家解放，没有剥削没有压迫以后没有事可干了，即使大家都平等了都解放了还需要服务，为人民服务比解放全人类更近了一步，依然要为人们服务的思想和精神，贯彻到融入到每一个活动中去，他怎么挣钱？挣钱为你们服务，为人民服务，他服务不好，挣不了钱，他挣钱是因为你们认为他服务很好，把钱交给他，为人民服务既是经济、政治、社会问题，他们是一致的。</p>
<h2 id="解读之四：中国式社会主义就是共享主义"><a href="#解读之四：中国式社会主义就是共享主义" class="headerlink" title="解读之四：中国式社会主义就是共享主义"></a>解读之四：中国式社会主义就是共享主义</h2><p>第四个，什么叫中国式社会主义？我简单来说社会主义就是共享主义，那么社会主义的经济基础是什么呢？社会主义经济基础就是观念经济，一个社会工业社会的时候不可能真正进入社会主义，工业社会的时候它的本质是竞争，竞争就是你死我活，不可能进入社会主义，要想进入社会主义经济基础必须要进入到智能社会，共享经济，社会主义才能成立。</p>
<p>我们说国家是初级社会主义，又什么是初级社会主义呢？我们说社会主义共享，共享什么呢？共享生产资料，首先是消灭了生产资料私有制，首先是1949年把生产资料先共享了，其他的方面还没有做到共享。</p>
<p>我们为了完成工业革命又进行了一定程度的私有化，共享又退回去了一些，这是因为工业社会不是共享的社会，你要想所有的生产资料共享工业社会无法完成了。现在又重新走向共享了，因为我们走进了新时代。</p>
<p>今后生产过程也要实现共享，生活资料也要实现共享。从这个意义来说，所有的发达国家其实从生产形态上他们已经进入了观念社会，都已经进入了社会主义社会，但是他们的政权不是社会主义政权。</p>
<p>他们政权是什么呢？是一个落后的政权，是一个保证资本的政权，是资本原则下保证资本能够顺利运营的政权。中国式社会主义是什么呢？大家已经在经济形态进入社会化了，在执政党的倡导下在国家组织支持下推动共享全面发展的过程，也就是说经济形态是一个共享发展的过程，执政党在组织和推行这个共享，西方政府不管发展共享的，它只保证资本主义的法律贯彻执行，不是有意推动这个共享，用国家能力推动共享的就是中国式社会主义，不用国家能力保证资本运行的就是资本主义国家。</p>
<p>所以说资本主义国家是什么呢？国家用权利，用国家的一切保证资本独享，而社会主义国家是用国家机器努力发展共享。现在大家提出共产党的合理性在什么地方呢？共产党执政的合理性，共享的核心是全民福祉，那么共享的核心就看共产党是否代表了全民的福祉。要是不代表全面福祉没有执政的合理性，你要代表了全民福祉合理性，共产党要进行合理的执政，公务员就必须廉洁奉公，非公务员的党员也必须作出共享的表率，我们党员一部分是执政的，执政就要廉洁奉公，不执政作出表率，做到这一点就有合理性。</p>
<hr>
<hr>
<hr>
<p>我解读完了四个基本点。这四个基本点得到贯彻执行的话，今后5年和10年中国出现什么状况呢？我讲十个判断。</p>
<h3 id="第一，今后的5年内中国将消灭绝对贫困。"><a href="#第一，今后的5年内中国将消灭绝对贫困。" class="headerlink" title="第一，今后的5年内中国将消灭绝对贫困。"></a>第一，今后的5年内中国将消灭绝对贫困。</h3><p>什么叫绝对贫困：吃不饱、穿不暖，没有房住。<br>只要吃饭穿暖有房住就不是绝对贫困的人，这是人类历史上一个极伟大的事，人类从来没有消灭过绝对贫困，我也不相信美国5年以后消灭绝对贫困，我相信美国5年以后还有流浪街头的人。<br>中国5年以内绝对贫困人口被消灭，中国历史上第一次出现大面积消灭绝对贫困的，多么伟大的事情。</p>
<h3 id="第二，农村将进行第二次改革。"><a href="#第二，农村将进行第二次改革。" class="headerlink" title="第二，农村将进行第二次改革。"></a>第二，农村将进行第二次改革。</h3><p>第一次改革是分田到户，第二次改革通过土地托管的形式再把土地集中起来，大流通大结合的现代化农业，我们第一次农业改革大约花三年时间，这次改革明年开始大约5年的时间完成。<br>完成了以后出现什么现象，中国所有的土地实现新型合作化以后，中国将增长1到1.5亿亩耕地，这样真正的农村城镇化就会实现。<br>习主席说了要一支爱农业、爱农村的队伍。<br>农村要完成农村工业革命，有情怀的人要参加，社会各界人士包括城里人也要参加的。<br>我相信这个成熟的方案推动全社会参与农村的改革，把我们的国家建设的更加美好。</p>
<p>第一个5年消灭绝对贫困，10年达到小康，什么叫有尊严生活呢？<br>不但吃饱穿暖有房住，还有选择性，我今天不吃馒头可以吃面包，有一定的休息了，可以旅游，就是一个非常伟大的事情。</p>
<h3 id="第三个，今后5年到10年，我估计10年时间完成给2亿3亿农民工一个家。"><a href="#第三个，今后5年到10年，我估计10年时间完成给2亿3亿农民工一个家。" class="headerlink" title="第三个，今后5年到10年，我估计10年时间完成给2亿3亿农民工一个家。"></a>第三个，今后5年到10年，我估计10年时间完成给2亿3亿农民工一个家。</h3><p>这是马上就提到议事日程的，现在他们还要住工棚，作为一个有初心的共产党不允许这样的情况延续下去。<br>我判断今后5年10年为农民工解决住房的问题。农民工的收入完全可以和城市人口比，现在大部分的农民工都回家盖了房子，但是不住，因为他们的工作环境不在那。<br>解决房子问题不光是稳定的问题，这些人要有正常的家庭生活，要过正常人的生活，这是有初心必须要解决的问题。<br>你们可以想象，解决两三亿人的住房是多么大房地产开发的局面。</p>
<font color="#FF4500">中国房地产到头了？我说远着呢。等到这一轮完成以后，中国房地产才到头了，</font>因为10亿人口有地方住了，我们现在还有两三亿人口没有地方住。<br><br><br>### 第四个，今后5年一定要提出科学立国。<br>因为什么呢？我们曾经进入两个阶段，<br>第一个发展生产力的问题，建工厂的问题，这个已经现在多了，<br>第二个阶段是技术问题，我们中国的技术水平已经达到了世界先进水平，不是每样技术都先进，但是我们已经进入技术先进的国家。<br>我们科学还落后，科学落后使我们再进一步发展没有后劲，我们下一个目标科学立国，科学立国又能够带动技术的全面发展，汇拢世界先进的人才，全世界的科技人才涌进中国，当全世界科技人才涌进中国的时候，中国一定是世界最强大的国家。<br><br><br>### 第五个，物联网生产和应用都在世界前列。<br>互联网大家知道，一个人一个手机，这个已经完成了，没有人没有手机。<br>物联网什么呢？我们身边每一个物，电视机，电冰箱，汽车都和网络连接在一起，物联网革命比互联网革命大很多很多倍，一个人只是互联网一个终端，<br><font color="#FF4500"><br>一个人周围有物联网起码20到30个终端，你可以想想物联网的发展比互联网大很多倍。<br>物联网应用最多是中国，中国是最大的制造业国家，而我们又是创新的国家。<br>未来，物联网比互联网还有大高潮。<br></font>


<h3 id="第六个，今后还有一个发展，既然我们进入了观念社会，进入了智能化生产，产品的智能化将全面推进。"><a href="#第六个，今后还有一个发展，既然我们进入了观念社会，进入了智能化生产，产品的智能化将全面推进。" class="headerlink" title="第六个，今后还有一个发展，既然我们进入了观念社会，进入了智能化生产，产品的智能化将全面推进。"></a>第六个，今后还有一个发展，既然我们进入了观念社会，进入了智能化生产，产品的智能化将全面推进。</h3><p>我们看到的任何产品现在是非智能的，在今后的一段时间内要做到全部产品都是智能的，全部都要装上芯片，都要互联网化，物联网是产品智能化的前提，前提本身要智能。<br>这个全世界都还没有起步呢，今后5年到10年要起步，这个起步中国又是和世界同时起步。<br>但是我们条件和我们国家领导人的态度使得我们中国在这个问题上走到世界前面。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">芯片会大发展, 紫光首当其冲</span><br></pre></td></tr></table></figure></p>
<h3 id="第七个，未来5年我们中国成为世界第二大医药产业大国。"><a href="#第七个，未来5年我们中国成为世界第二大医药产业大国。" class="headerlink" title="第七个，未来5年我们中国成为世界第二大医药产业大国。"></a>第七个，未来5年我们中国成为世界第二大医药产业大国。</h3><p>未来10年我们中国人民享有医疗服务条件要接近世界先进水平。<br>从产值方面达到世界先进水平并不难，因为中国人口多。<br>服务水平达到先进水平非常了不得了，是不是我们产值达到世界第一呢？<br>现在不好说，为什么呢？我判断不出来中国的医药发展的价值方向。<br>比如说美国一个抗体药一个疗程50万美金，200万人民币；现在我们比美国便宜10分之1，我们14亿人口只能有他的一半，所以你的产值和价钱在一起的。<br>我们中国会实行底价的治疗制度，真实的价值来说我相信中国未来10年是世界第一健康产业大国，GDP算不一定，这是我们国家的价值政策和健康政策的问题。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">华润三九 国药 复星医药等</span><br></pre></td></tr></table></figure></p>
<h3 id="第八个，教育要有重大的发展。"><a href="#第八个，教育要有重大的发展。" class="headerlink" title="第八个，教育要有重大的发展。"></a>第八个，教育要有重大的发展。</h3><p>因为科学发展我们可以靠引进人才，教育发展不能靠引进。而教育是一个今后我们国家长期发展，长期立于世界之巅的政策。</p>
<h3 id="第九，中国的GDP在未来5年内发展速度在8到10之间，甚至更高。"><a href="#第九，中国的GDP在未来5年内发展速度在8到10之间，甚至更高。" class="headerlink" title="第九，中国的GDP在未来5年内发展速度在8到10之间，甚至更高。"></a>第九，中国的GDP在未来5年内发展速度在8到10之间，甚至更高。</h3><p>为什么作出这样的判断呢？这几年我跟大部分的经济学家观点不一样，他们说断崖式，我说不对。<br>为什么我们现在GDP增速下降，不能说财富增长呢？<br>今后GDP要继续增长，两三亿农民工解决住房问题，多少钢筋、水泥、建材，这些又会拉动传统产业的发展。<br>我们一方面通过农民工过户把传统产业再掀起一个高潮，<br>另一方面智能制作、物联网，产品智能化两个轮子一块驱动，8%到10%不是问题。<br>所以，我认为今后5年到10年不但是新兴产业看好，传统产生也看好，钢铁也会忙的，现在钢铁好起来了，以后会更忙。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">钢铁 水泥等传统行业会继续大发展</span><br></pre></td></tr></table></figure></p>
<h3 id="第十个问题，我们在今后的5年到10年内解决台湾问题。"><a href="#第十个问题，我们在今后的5年到10年内解决台湾问题。" class="headerlink" title="第十个问题，我们在今后的5年到10年内解决台湾问题。"></a>第十个问题，我们在今后的5年到10年内解决台湾问题。</h3><p>如果和美国由于某种原因达成共识的话，5年内解决台湾问题，最迟不过10年。<br>为什么台独呢？因为有民意基础，台湾人民有一直非常可笑的优越感，就跟香港一样。<br>第二个，是无知的恐惧，认为大陆制度水深火热。而现在，全世界看到了中国的力量，中国的社会不是可怕的社会，是一个幸福的社会。<br>富在深山有远亲，他们都明白了以后和大陆结合是他们台湾唯一出路，民意会瞬间发生变化，今天是这样，明天瞬间变成那样。<br>随着我们国力增长，我们制度的改革，治理方式的改革，越来越呈现出我们大陆整体的优势。这种优势会改变台湾民众基本的认识，这就是基本点。解决台湾问题不需要打仗的，但是也不能没有武力。到10年以后中国在军事上会连美国都惹不起，美国没有争议没有人敢争。国力和军力摆在那，10年以后中国的军力至少做到台湾问题没有人敢干涉，那个时候加上台湾民意的改变，回归是必然的事情。</p>
<p>我做了四个解读十个研判，请你们大家记住，然后我们用时间来证明，看看这个研判能不能实现？我希望研判每个都实现，如果每个都实现的话咱们大家鼓鼓掌。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/21/不畏浮云遮望眼：黄江南关于十九大的四个解读和十个判断/" data-id="cjj7xy5h3000mwes6o8465pr3" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-高粱：两种根本不同的经济改革观" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/21/高粱：两种根本不同的经济改革观/" class="article-date">
  <time datetime="2018-02-21T13:52:00.000Z" itemprop="datePublished">2018-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/economics/">economics</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/21/高粱：两种根本不同的经济改革观/">高粱：两种根本不同的经济改革观</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>两种根本不同的经济改革观</p>
<p>　　——论清算新自由主义思潮的影响</p>
<p>　　我国的改革开放，是以中国特色社会主义道路为前提的改革，是要完善社会主义，而不是取消社会主义基本制度。</p>
<p>　　对新自由主义在中国的影响不可低估。一些外国政要、国际组织及国内某些人极力推介无限期无底线的“市场化改革”，甚至明确提出要全盘“私有化、去政府化”，居心叵测。对此，我们要旗帜鲜明地予以批驳。</p>
<p>　　“中国道路”与新自由主义的分歧是原则性的。2008年金融危机以来，世界各地针对“华盛顿共识”和资本主义全球化所带来的种种恶果如跨国资本垄断、贫富差距急剧扩大、金融投机势力的掠夺等，进行广泛了的反思，形成了批判新自由主义经济理论的潮流。</p>
<p>　　但是在中国国内，对新自由主义的批判和反思并没有得到很大反响。</p>
<p>　　一方面，上世纪80年代初开始，经济改革就是通过引入市场竞争、破除旧的一整套行政性计划体制、放开私人经济、实行多种经济成分进行的，和当时西方经济政策自由化趋势有共通之处。我国在引进西方经济学在丰富和更新了经济分析工具的同时，也引进了新自由主义极度崇拜市场和私有制的意识形态。这种自由主义价值观的形成由来已久，要厘清其错误影响非一日之功。</p>
<p>　　另一方面，过去30多年来，市场化改革破除了旧体制束缚，激发了社会经济活力，确实是我国经济高速成长的重要因素。为此，社会上普遍存在“改革开放是经济建设成就的唯一因素”的印象。这一印象被深受新自由主义影响的学者们的渲染放大，形成了“计划经济一无是处、近30年发展成就仅归功于市 场化改革、和政府作用无关”“经济成就都来自市场化，出现的问题的原因都是政府干预、市场化改革不到位”等等片面化、绝对化的论调。</p>
<p>　　长期以来，关于经济改革中的一系列问题，如国有经济地位、市场作用和政府与市场的边界等问题，经济理论界争议很大，号称的“主流”学者多带有自由化倾向，甚至有意无意地淡化“中国特色社会主义”、“一个中心两个基本点”这些根本性原则，而有意无意地代之以新自由主义的“改革”目标诉求，甚至有人对“中国道路”、“中国特色”持根本否定态度。</p>
<p>　　概括地说，“中国道路”的意见是：坚持基本经济制度，坚持政府管理和市场机制都是为经济发展战略服务的工具，坚持共同富裕理想，坚持维护国家主权和实行平等互利的对外经济政策。而“自由派”学者则要求无条件地、不断地“推进民营化、市场化、去行政化”，推进“国内市场和国际接轨”。在他们那里，市场已成为意识形态(市场原教旨主义)。两种思想路线分歧的本质，是两条道路之争、大是大非之争。</p>
<p>　　必须承认，新自由主义的思想倾向对我们的经济政策的制定影响不小。我们必须清楚地区分两种不同性质的改革思路，对“唯市场、唯私有产权”的绝对化的思想和政策诉求给予明确的拒绝。</p>
<p>　　慎对新自由主义使中国避开了东欧陷阱，只要对中国百年来经济发展，特别是新中国前后30年的发展历史稍有研究，就不会轻率得到“前30年一无是处、市场是唯一灵丹妙药”的结论。</p>
<p>　　我国改革开放得以成功的前提有三个，一是我国在20世纪的革命和建设取得巨大成就、取得与西方平等相处的政治地位;二是通过计划经济的动员体制、全国人民艰苦奋斗，初步建成独立自主的工业、科教、基础设施体系，全民文化素质普遍提高，从而有条件在开放引进中基本保持民族经济的主体地位和国家调控能力;三是中国社会主义基本制度的建立凝聚了全社会，政府社会管理及社会动员能力空前提高，从而形成了多数发展中国家无法相比的政治优势。</p>
<p>　　党和政府在领导经济体制改革过程中，始终保持了清醒思考和独立决策，坚持一切从实际出发的思想路线和工作方针，在推进改革中兼顾维护稳定和促进发展两大目标，没有听从国内外不负责任的“一步到位”转型的劝诱，从而避开了拉美和东欧的陷阱。</p>
<p>　　看不到这些因素，就无法理解同样实行“市场经济、对外开放”的许多国家为什么经济发展绩效的差别如此之大，就会陷入认识论的片面性和绝对化。这些因素，其实都是众所周知的事实。但在那些坚持自由主义的学者那里，他们宁愿装聋作哑。他们看到的或相信的，只是符合自己口味的事实。</p>
<p>　　研究比较国外案例，吸取他们的经验教训，对深入认识经济制度、运行机制和经济社会发展的关系，有重要的意义。它有助于开阔眼界、破除迷信(目前主要是市场原教旨迷信)。</p>
<p>　　私人所有和市场制度，广泛存在于各民族的历史中。而不同历史时期的各地区、各民族的经济发展情况千差万别。一个国家在一定时期的资源禀赋、社会政治条件、国际环境、人民素质、国家发展目标、经济制度及体制、具体政策，都是影响经济运行效能(竞争力)的因素。制度因素(市场机制或政府干预程度)只是决定经济运行绩效诸多因素之一。只有放在具体的历史条件中进行分析，这一因素的作用才能说清楚。</p>
<p>　　20世纪80年代，国内学界对国外经济的研究，偏重介绍市场经济的正面效果。如西德1948年放开经济统制(来自竞争的繁荣)、亚洲四小龙的开放型市场经济，以及东欧改革的经验。而对那些因听信西方劝诱实行“去国有化、去行政监管化”(如南美)导致失败的教训则讳莫如深。</p>
<p>　　20世纪90年代以来，全球经济一体化，贸易、投资自由程度空前提高。一方面是中国及“金砖五国”的经济崛起;另一方面，美欧经济“产业空心化”和“泡沫化”，为数众多的国家发展停滞甚至出现危机。《新自由主义的经济成绩单》列举了拉美、东南亚等发展中国家和东欧休克疗法等案例，由于新自由主义政策的推行，造成经济减速或衰退、私有化造成国有资产流失和经济主权削弱、失业增加、工会权利受限、劳工地位下降、全球范围的结构失衡和金融泡沫膨胀等恶果。</p>
<p>　　1997年东南亚金融危机、拉美20年来经济的停滞和频频出现的危机，说明当今的全球市场是极度不平等的市场，不论在金融业还是实体产业都是由发达国的跨国公司主导或垄断的市场。现实的“市场”是弱肉强食的竞争场。在不对等的市场环境中，自由贸易、自由投资总是有利于强者。面对这样的竞争条件，后进国家的市场是否要开放或开放到什么程度，对本国幼稚产业是否应该或在什么程度上加以支持或保护，属于发展中国家头等重要的经济战略选择。以一国的某个很短的历史时期的经验来支持无条件、无底线开放或“融入”全球化的论调，是十足的理论浅薄。</p>
<p>　　看拉美某些国家，非理智地接受WB或IMF的全面开放和市场化(将国有大银行和基础行业等命脉性企业以私有化为名卖给外资、金融高度自由化)，这种毫无设防的“融入”政策，正好给跨国公司掠夺本国人民的财富开了方便之门。</p>
<p>　　20世纪80年代，我国经济学界十分关注东欧经济改革的理论和实践。当时有位波兰学者建议实行“一揽子”改革，同时极力反对以“双轨制”为代表的渐进思路，理由是“市场经济是一个整体的系统”。这一主张最后以“休克疗法”的名义在解体后的俄罗斯和东欧诸国得以实施。其灾难性的后果，今天已经无可争辩了。但为什么同样引进市场竞争，东欧和西欧、和中国都不一样呢?国内看到的最有说服力的解释如下。</p>
<p>　　“东欧转型之初，苏联单方面解散华沙条约和经互会条约，片面对西方开放，立即打碎东欧原有的分工协作，企业的零部件供应普遍中断。东欧国家间约一半以上的贸易在社会主义国家间进行。市场自由化的西方标准，要求一切外贸以西方的硬通货结算，社会主义国家间原来通行的物物交换或以卢布结算的分工体系立即瓦解。贸易自由化系东欧片面对西方开放，而西方并没有同时对东欧开放市场。这导致西方低端的日用品连手纸也大量涌入东欧，而东欧原来有价格优势的农产品(000061,股吧)和工业品，因为不熟悉西方的营销网络和质量标准而被挡在门外，导致东欧企业大批倒闭。私有化过程中东欧普遍缺乏货币资本，东欧的私有化进程使西方跨国公司得以廉价，甚至被东欧政府补贴，来收购东欧的核心企业。”</p>
<p>　　“相比之下，中国开放之初的高关税保护了民族企业的生存空间，选择性的特区开放又使国有和民营企业逐步学会和外国企业竞争，所以技术和人才远比东欧落后的中国企业，在转型过程中能快速成长，民族企业逐步学会和跨国公司竞争。”(《陈平：资本主义战胜社会主义了吗?—评科尔奈&lt;警惕近在眼前的威胁&gt;》，摘自观察者网)</p>
<p>　　当年俄国的丘拜斯、盖达尔等“改革智囊”因设计和推进“激进转型”，而博得西方一片喝彩。后人看这段历史，一个曾令全世界敬畏的工业科技大国，因人为的政策失误而急剧衰落。这班缺乏经济实感、仅靠从西方书本抄来的教条就敢搞事关国运的“顶层设计”的“智囊”，只能列入“书生误国”、“民族罪人”一类。</p>
<p>　　从今天世界市场竞争“大鱼吃小鱼、小鱼吃虾米”的现实出发，而不是从纯“学理”出发，我们只能得出这样的结论：以鼓吹后进国家对外全面撤除防护屏障、对内撤除国家的经济管理职能、拆除国家支柱企业、放纵私人资本的新自由主义诉求，是不折不扣地为资本特别是为西方大资本剥夺后进国家人民血汗鸣锣开道的工具。认识新自由主义的本质，警惕其对我国改革事业的误导、清算其对我政策的影响，是十分重要的任务。对此，需要进行充分理论探讨和中外经验的研究。</p>
<p>　　应克服新组织的负面影响，30多年来，市场化激励了经济的大发展，也积累了越来越多的社会问题：社会分化明显化、贫富差距急剧扩大，官民关系紧张，医疗、教育市场化加重人民负担，住房市场化催生金融泡沫，等等。一些人不遗余力地宣扬这些问题的根源是“政府管的太多、国企拉大差距”，主张“改革中的问题还要靠深化改革解决”，其实背后的诉求是用“彻底市场化”来抹平劳资收入差距、来解决“唯利是图”的市场逻辑和公共服务的社会福利性质的矛盾，纯属强词夺理，越来越没有听众。</p>
<p>　　就经济发展本身来说，在自由主义倾向的影响下，我国的经济改革和发展政策，也有不少值得检讨之处。</p>
<p>　　——理论界盛行对“市场化、自由化”教条的迷信和为改革而改革(将市场看作目标本身)的倾向。不少人固守30年前的老经验，将国企产权改革、反垄断、鼓励非公经济、减少政府干预等诉求绝对化，缺乏工业和技术的基本知识，对我国工业面临的国际竞争、自身状态、前进方向(自主创新和产业升级目标)若明若暗。</p>
<p>　　——改革的着眼点，仅限于推进国内的市场化，无视全球化的环境和强势外资的挑战，开放缺乏分寸感和“度”的把握。过于相信“自由贸易”教条、迷信“外资=中国企业”，单方面对外资实行普遍优惠，放任外资扩张渗透。面对跨国公司的系统竞争优势(规模、组织、技术、国际营销等)，缺乏应对思路和相应政策。</p>
<p>　　——经济发展战略长期受“唯GDP、比较优势论”影响。“引进消化吸收——促进产业技术进步”的基本方针一度被淡化，组织重大技术和装备的国产化政策执行不力。有人将以国企为主体的工业核心部门斥为“错误的赶超战略”的产物，主张任其在国际竞争中自生自灭。片面宣扬“融入全球化”、“承接西方产业转移”，各地竞相招商引资、抓GDP，忽视培植自主技术能力和产业体系、忽视自主开拓国际市场，经济发展主导权部分旁落。</p>
<p>　　——淡忘“以我为主”的科技——工业现代化战略，过分依赖“市场换技术”，耽于“引进外资=引进技术、买技术成果=获得技术能力”幻觉，弱化政府协调的科技攻关机制，分头引进外资或技术，对西方技术封锁被动应付。自主创新的意志和能力受到压制。</p>
<p>　　笔者认为，以上所列恰是我们的经济发展方式中最需要转变的内容。</p>
<p>　　经济发展方针要坚持以我为主，要让经济发展的收益惠及多数群众。要以自主科技创新增强产业在全球市场的竞争力，要坚持和加强国家对基础性、支柱性、命脉性行业的控制力。只有明确以上基本目标，才能明确多种经济成分中国有经济的最低限度规模，才能根据实际的发展需要明确资源配置和经济管理等领域中政府职能和“市场决定”的边界，而不是仅仅以某个外国书本为依据。</p>
<p>　　中共十八大报告中说，我们不能走封闭保守的老路，也不能走改旗易帜的邪路，要坚持中国特色社会主义道路。今天要特别注意清算新自由主义的影响，警惕内外勾结、诱骗我们改旗易帜的图谋。</p>
<p>　　【作者简介】顾南九(1948年—)，乳名高粱，出生于山东滨州。中国著名思想家、经济学家，为经济学家顾准的次子，经济学家吴敬琏门下的研究生、专攻比较经济制度，现任国家发改委经济体制与管理研究所学术委员会秘书长，国家发改委大飞机项目协调小组负责人。2004年8月，郎咸平挑起“郎顾之争”，从而掀起了所谓“第三次改革大争论”。顾南九和其他“非主流经济学家”一样，公开支持郎咸平，加入了 “反思改革者”的行列。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/21/高粱：两种根本不同的经济改革观/" data-id="cjj7xy5hr002awes6coo5gfnr" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-从市盈率看创业板" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/21/从市盈率看创业板/" class="article-date">
  <time datetime="2018-02-21T13:51:59.000Z" itemprop="datePublished">2018-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/economics/">economics</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/21/从市盈率看创业板/">从市盈率看创业板</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>美国纳斯卡克平均市盈率为    34</p>
<p>中国创业板平均市盈率为         45</p>
<ol>
<li>无论是技术创新性 还是制度创新, 都远不及纳斯达克</li>
<li>全世界的创业板也只有纳斯达克成功了, 其他国家的创业板均无成功案例</li>
</ol>
<p>综合以上两点, 站在极其乐观的角度去看, 中国创业板PE怎么也得30以下才可能值得参与. 即1000点出头.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/21/从市盈率看创业板/" data-id="cjj7xy5h5000owes6nlo0k11w" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-华生--01--改革最忌欲速而不达，成功取决于路径和方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/21/华生--01--改革最忌欲速而不达，成功取决于路径和方法/" class="article-date">
  <time datetime="2018-02-21T13:51:57.000Z" itemprop="datePublished">2018-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/economics/">economics</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/21/华生--01--改革最忌欲速而不达，成功取决于路径和方法/">华生--01--改革最忌欲速而不达，成功取决于路径和方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文题目：《改革最忌欲速而不达，成功取决于路径和方法》 (2016-04-20 08:30:20)<br><a href="http://blog.sina.com.cn/s/blog_48e91e520102xfpf.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_48e91e520102xfpf.html</a></p>
<p>其实重要的在谈注册制和借壳重组问题，今天转载的三篇文章几乎都在讲，现在证监会有采纳他的建议意向，值得关注言论！</p>
<p>注册制内涵不清</p>
<h4 id="《财经》：今年的政府工作报告不再提注册制，市场理解为可能暂缓。对此，您怎么看？"><a href="#《财经》：今年的政府工作报告不再提注册制，市场理解为可能暂缓。对此，您怎么看？" class="headerlink" title="《财经》：今年的政府工作报告不再提注册制，市场理解为可能暂缓。对此，您怎么看？"></a>《财经》：今年的政府工作报告不再提注册制，市场理解为可能暂缓。对此，您怎么看？</h4><p>华生：暂缓是肯定了。我觉得主要是由于去年股市的异常波动所致。<br>说明中国股市对整个经济社会的影响还是非常广泛的，包括在经济下行的情况下，影响各方面包括国际上对中国经济的信心。<br>这场波动后，应当说高层在思想上有调整，希望减少市场震荡、增强人们对中国经济稳定发展的信心。<br>所以，宁可放慢注册制推进的步伐，也希望能有一个相对稳定的市场。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">延续了我国改革的一贯作风, 稳字当先.</span><br></pre></td></tr></table></figure></p>
<h4 id="《财经》：有一段时间，一提注册制市场就下跌，注册制真有这么恐怖么？市场为什么这么惧怕注册制？"><a href="#《财经》：有一段时间，一提注册制市场就下跌，注册制真有这么恐怖么？市场为什么这么惧怕注册制？" class="headerlink" title="《财经》：有一段时间，一提注册制市场就下跌，注册制真有这么恐怖么？市场为什么这么惧怕注册制？"></a>《财经》：有一段时间，一提注册制市场就下跌，注册制真有这么恐怖么？市场为什么这么惧怕注册制？</h4><p>华生：我在注册制刚提时就指出，注册制的提法先天不足，本身有很多问题。<br>我当时提的是二次股改。<br>其内容很清楚，<font color="#FF4500">一次股改解决了产权界定问题，二次股改就是要解决发行制度的市场化。</font><br>我们所谓的注册制也是为了推进发行制度的市场化。</p>
<p>但用注册制这名字问题在哪？<br>主要是注册制的含义并不清楚，包括今天大家还不是很清楚。<br>是美国的注册制么？因为香港也不是注册制。<br>那我们是否要抄美国的注册制？</p>
<p>应当说注册制的内涵并不清楚，也没有经过充分的论证。</p>
<p>这两年，注册制的概念也是在不断修改。<br>开始说注册制多好，好像能解决所有问题。<br>后来又说注册制也不是随便就可以上市。</p>
<p>那注册制是什么？换了一个形式的审批制？还是把审批从证监会换一个地方到交易所？</p>
<p>世界上市场化发行的制度多种多样。只有美国，被有人称之注册制。</p>
<p>但美国是大进大出，每年新上几百家企业，退市的企业也有几百家。<br>我们现在几年退一家企业都很难，还敢讲注册制？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">改革继续稳字当先,</span><br><span class="line">我国大概率不会发生大规模退市的情况, 那样容易引起社会不稳定, 投资失败者滋事.</span><br><span class="line">更可能的是大部分中小股票反复寻底, 出现几毛钱 几分钱的无人问津的仙股, 类似香港市场.</span><br></pre></td></tr></table></figure></p>
<p>其实美国也不是随便到那儿注册都能上的。我们知道许多中国公司去美国上市也并不容易，费用很高，要求也不低。</p>
<p>所以注册制是不是洪水猛兽，取决要做的是个什么样的注册制。<br>如果真如市场上很多人理解的那样，不管什么企业，盈利与否，只要如实披露就可以上。<br>以中国股市今天这么高的市盈率，人人都眼红的高估值，连已经在美国上市的中概股都花大钱退市回来上市，中国自己可以和想上市的企业更是以万家计。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">全球化的时代, 资产价格也需要全球化,</span><br><span class="line"></span><br><span class="line">A股因为审批制使得股票供给不足, 造成价格堰塞湖,</span><br><span class="line">长远角度来看, 绝大部分中小股票会向欧美市场靠拢, 反复寻底. 创业板市盈率至少要<span class="number">30</span>以下, 甚至<span class="number">20</span>, <span class="number">15</span>都有可能.</span><br><span class="line"></span><br><span class="line">如果想保持指数不过于难看, 有<span class="number">2</span>种办法</span><br><span class="line"><span class="number">1.</span> 经济方面要高速发展; 人为拉高上市门槛, 确保供给不要过快增加.</span><br><span class="line"><span class="number">2.</span> 国家托市, 拉抬大蓝筹. 稳住指数.</span><br><span class="line">目前来看, 似乎<span class="number">2</span>种办法都采用了, 尤其是办法<span class="number">2</span>的比例较多.</span><br></pre></td></tr></table></figure></p>
<p>这么多人把A股市场当作提款机，那么沪指2000点肯定是守不住的，大家做好准备承受了吗？（评：也许证监会参考了华生言论，才讨论中概回归问题）<br>改革要对症下药</p>
<h4 id="《财经》：注册制的本质是要搞发行制度的市场化。但这跟股权分置改革一样，是个高难度的事情，需要大智慧以及高度的技巧去设计路径。您对路径的设计有何建议？"><a href="#《财经》：注册制的本质是要搞发行制度的市场化。但这跟股权分置改革一样，是个高难度的事情，需要大智慧以及高度的技巧去设计路径。您对路径的设计有何建议？" class="headerlink" title="《财经》：注册制的本质是要搞发行制度的市场化。但这跟股权分置改革一样，是个高难度的事情，需要大智慧以及高度的技巧去设计路径。您对路径的设计有何建议？"></a>《财经》：注册制的本质是要搞发行制度的市场化。但这跟股权分置改革一样，是个高难度的事情，需要大智慧以及高度的技巧去设计路径。您对路径的设计有何建议？</h4><p>华生：对，如果把注册制理解为比较彻底的市场化发行，那么注册制就是发行市场化改革的目标和终点而不是起点。<br>就像上世纪80年代我们搞价格改革，目标是从完全僵死的计划经济价格过渡到市场价格，但一步过渡就会天下大乱、经济崩溃，这样就要有方法和路径，让大家有个学习和适应的过程。</p>
<p>股市发行市场化改革也是这样，首先要看清中国证券市场过渡期面临的障碍和困难是什么。</p>
<font size="4" color="#FF4500"><br>A股市场在股权分置改革后的最基本国情，就是大盘股低估、中小盘股高估的扭曲股价结构。<br>国际市场都是大盘股估值高，小盘股比较低。<br></font><br>一切改革措施不从这个基本国情入手都会事与愿违、碰得头破血流。<br><br>为什么唯独A股市场形成了中小盘股、垃圾股高溢价的股价结构？<br>将此归结于中国人的投机文化显然有失偏颇。香港市场台湾市场也是中华文化，市场估值结构就与国际成熟市场趋同。<br>A股的问题<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一是供给端的管制；</span><br><span class="line">二是中国特色的资产重组制度，即所谓的壳资源重组。前者是病根，后者火上浇油。</span><br></pre></td></tr></table></figure><br><br>一个个垃圾股变黄金、乌鸦变凤凰的案例推动了市场如蝇逐臭的投机文化。<br><font size="8" color="#FF4500"><br>市场化改革确实会打击大多数中小盘股的估值。<br>市场化改革只要往前推，中小盘股的估值就得大幅度下降。<br>这是全世界的普遍规律。<br></font><br>由于中国是以散户为主体的市场，而且绝大多数都买的是中小盘股，这就有个市场的承受力问题。这是改革的难点所在。（评：看的清）<br><br>#### 《财经》：但是资产重组是证券市场的重要功能，收购兼并在国际成熟市场也极其普遍。去年证监会鼓励并购重组，也是基于整个经济转型的大背景下，促进上市公司深入推进行业整合和产业升级。<br><br>华生：这是混淆了国际成熟市场上以产业整合为基础的收购兼并与我国借壳重组（评：近期热门，不妨参考）的本质区别。<br>西方成熟市场上的收购重组一般是同行业兼并，都是有产业背景和以优化资源配置为基础的。<br>所以我们经常看到如美国市场上的收购兼并常常是强强合并，购并额动辄几百亿、几千亿美元。<br>他们的市场上绝不会有优质企业去借壳垃圾企业，因为好企业肯定自己直接上市，不会去给别人分利。<br><br>中国特色的资产重组则是由于上市排队时间太长，一些好企业不能不去借壳已经衰败的企业，这就像不断把年轻人的血输给老年人，不惜代价让垂死的人再返老还童。<br><br>由于这些并不是基于产业背景的购并重组，对于实体经济毫无意义，并没有任何真实的产业整合、规模扩大和资源使用的优化。<br>但对上市公司而言却像打了一针强心剂，乌鸦一下子变凤凰，或者至少是暂时打扮漂亮，可以迷惑人了，至于不行了以后还可以反复再重组。<br>这让辛辛苦苦做基本面研究和价值投资还不如赌重组来得容易。<br><br>这样就扭曲了市场估值。本来的烂变成了好，丑变成了美。好企业估值不高，烂企业估值不低，投资标准严重混乱，从而极大助长了市场的投机性。（评：这段话说的棒，乌鸦变凤凰，不行了反复可以重组，基本面研究不如赌重组，谁还搞企业研究，证监会要对壳股出手，貌似真的是听了华生的）<br><br>#### 《财经》：其实退市制度之所以推得那么难，一方面企业上市很不容易，一旦退市，无论是对地方政府还是投资者的打击都会很大，尤其是投资者，所以退的路上不停地有救。<br><br>华生：现在很多人说退市不容易，退市会来自地方政府的压力等。其实许多壳公司是民企，跟地方政府的关系真没那么大。我们有一段时间也下了不少，到老三板去的。关键是没有把规矩划严。<br><br>当然，美国是一个机构为主的市场，这和我国散户为主的市场不同。其实，退市只是净化市场的最后手段而不宜作为常规手段。严格地说，退市主要惩罚的是中小投资者，让他们用血的代价去认识小盘绩差股的风险。<br><br><font size="8" color="#FF4500"><br>退市制度的实质是什么？其实不是退，而是让价格反映它的价值。<br>可以像美国那样一年退几百家，也可以像香港那样不退也行。<br><br>改革的实质是让市场发挥作用，让值一分钱的东西就是一分钱，这时退不退本身就不重要了。<br></font>

<h4 id="《财经》：那您觉得退市如此的难的深层次原因是什么？"><a href="#《财经》：那您觉得退市如此的难的深层次原因是什么？" class="headerlink" title="《财经》：那您觉得退市如此的难的深层次原因是什么？"></a>《财经》：那您觉得退市如此的难的深层次原因是什么？</h4><p>华生：就是因为壳可以重组，还很值钱，有大量散户投资者在里面，有几十亿市值在那儿，就像要对年轻人说死亡一样，当然就很残酷、就很难。<br>所以执行起来总是留了大量的政策空间。</p>
<p>为什么留呢？另一个深层次的原因是政府急功近利的短期行为，为了维持眼下的繁荣，希望市场在我这先繁荣着再说，深层次问题以后再解决。<br>投资者也迎合这个，先能炒作赚钱再说，制度合理不合理与我无关。这是深刻的国情。</p>
<p><font size="8" color="#FF4500"><br>退市的核心问题取决两个，<br>一是取决于监管层的决心有多大；<br>另外，资产重组政策是个风向标。<br></font><br>根本还是决策人的决心和取向问题。允许重组的话，再烂的企业也总有办法救活。<br>好几年才搞一两个当样子，以证明有退市。那啥问题也不解决。（评：这段话深刻，形象，看证监会决心了，继续关注借壳问题）</p>
<p>路径和方法</p>
<h4 id="《财经》：发行市场化改革的突破点应该从哪里开始？"><a href="#《财经》：发行市场化改革的突破点应该从哪里开始？" class="headerlink" title="《财经》：发行市场化改革的突破点应该从哪里开始？"></a>《财经》：发行市场化改革的突破点应该从哪里开始？</h4><p>华生：先从刚才说的几个问题的纠正开始。<br>比如壳资源重组。应该禁止没有产业整合背景的壳资源重组。<br>可以给半年、一年的过渡期，跟历史衔接。<br>照顾市场的既得利益，使投资者有调整和退出的时间和机会。（评：这要真执行，大家要注意手里的票）此后一个都不准借壳重组或变相重组。<br>现在的创业板说是不允许借壳了，但变相借壳依然很多。<br>其实，相当于还是允许。<br>如果真的严格执行了，会让此后所有的壳资源、中小盘下跌。<br>其实，下跌就对了。这样股价结构的扭曲才能改善，资本市场的功能才能发挥。<br>而我们现在的资本市场是鼓励做坏的企业。企业经营再坏了没关系，卖壳还值大价钱。这种市场能搞好才怪。</p>
<p>中小盘股的估值跟大盘股的价格扭曲，是当下中国资本市场最大的国情。一切措施不从这入手都会碰得头破血流。（评：中小盘股的估值跟大盘股的价格扭曲，是当下中国资本市场最大的国情。这句话直击高层内心，国家队手里大把大盘股，哈哈）</p>
<h4 id="《财经》：既然注册制是方向，那什么情况下算是准备好了？"><a href="#《财经》：既然注册制是方向，那什么情况下算是准备好了？" class="headerlink" title="《财经》：既然注册制是方向，那什么情况下算是准备好了？"></a>《财经》：既然注册制是方向，那什么情况下算是准备好了？</h4><p>华生：市场化改革本来没有是否准备好的问题，只要方法路径正确，时不我待。现在首先是要在资本市场上拨乱反正。（评：拨乱反正来了，注意了各位，看好方法，证监会可能真采取哦！）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">第一步：先把中国特色的资产重组给废了。让市场上好企业有好的价格，坏企业有坏的价格。</span><br><span class="line">不能借壳重组，壳资源没价值，价格自然回归。</span><br><span class="line">价格信号要正确，这是市场经济的起点。</span><br><span class="line"></span><br><span class="line">第二步：如果想市场化，先从难度较小的再融资市场化开始。</span><br><span class="line">先学走，再学跑，风险小的还没开始，不能上来就搞个大的。</span><br><span class="line">世界上虽然没有新股可以自由上市的备案制，但已上市公司的股权和债权私募再融资的备案制却是真正的国际惯例。</span><br><span class="line">再融资的市场化是发行市场化的逻辑起点。</span><br><span class="line">已经上市公司的再融资都不能市场化，就大讲未上市、想上市企业进场的市场化，这是自相矛盾的大话空话。</span><br><span class="line"></span><br><span class="line">第三步：发行价格和发行节奏的市场化要周密规划，分步实施，各个击破。</span><br><span class="line"></span><br><span class="line">总之，发行市场化的内容很多，要分解分散风险，逐一突破，才能最终达到目标。</span><br><span class="line">不能笼而统之就喊一个谁也解释不清的注册制，霸王硬上弓，那样反而会事倍功半，反复折腾。</span><br></pre></td></tr></table></figure>
<h3 id="《财经》：其实要说困难，之前的股权分置改革不比这个容易。十多年前，您较早提出了股权分置改革，并积极参与和推动了整个股改过程。您觉得有什么可以吸取的经验？"><a href="#《财经》：其实要说困难，之前的股权分置改革不比这个容易。十多年前，您较早提出了股权分置改革，并积极参与和推动了整个股改过程。您觉得有什么可以吸取的经验？" class="headerlink" title="《财经》：其实要说困难，之前的股权分置改革不比这个容易。十多年前，您较早提出了股权分置改革，并积极参与和推动了整个股改过程。您觉得有什么可以吸取的经验？"></a>《财经》：其实要说困难，之前的股权分置改革不比这个容易。十多年前，您较早提出了股权分置改革，并积极参与和推动了整个股改过程。您觉得有什么可以吸取的经验？</h3><p>华生：三年前注册制刚提出时，我就拿国有股减持的案例提醒过。为什么当初的国有股减持会失败，就是开始对于困难估计不足，后来市场反应非常剧烈，发现没那么简单，又退回来。最后损失的还是市场参与者，政府的威信也受损。结果这次注册制还是重复了这种弯路。所以，以后决策一定要慎重，万一有问题，就像去年的熔断一样，发现不对要赶紧改，不能要面子。（评：听了华生的话？）</p>
<p>股权分置改革的成功则是经过了充分的酝酿。<br>从民间开始讨论了很多年。经过广泛的争论最后才进入国务院的文件。<br>充分地集中了民间的智慧。<br>它的过渡路径设计的也比较好，不是一下子放开。<br>其实，国家一开始也想通过国有股减持硬闯。<br>结果失败了，才开始重新讨论设计。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">尚福林 李青原 王波明 等人做出了巨大贡献</span><br></pre></td></tr></table></figure></p>
<p>注册制改革现在的关键反而是千万不要因为去年的挫折动摇了市场化改革的决心和方向。<br>希望这次能广泛吸收各方面的智慧，拿出确实可行的过渡办法，切实解决发行制度市场化中的各种挑战和问题。<br>发行市场化改革老停在这儿也不行，目前这种炒作严格地说只是饮鸩止渴，而资本市场不健康不能发挥其功能会制约和影响中国经济前进的步伐，这样会误了大事。</p>
<h4 id="《财经》：对于注册制的路径设计，您有什么建议？"><a href="#《财经》：对于注册制的路径设计，您有什么建议？" class="headerlink" title="《财经》：对于注册制的路径设计，您有什么建议？"></a>《财经》：对于注册制的路径设计，您有什么建议？</h4><p>华生：现在新主席也到位了，的确要好好设计一个方向明确、符合国情的而不是顾头不顾尾的方案。</p>
<p><font color="#FF4500"><br>当前中国经济面临下行的很大压力，本来资本市场是撬动经济发展的重要推动力。<br>但现在资本市场起不了这个作用，甚至还帮倒忙，这是很可惜的。关键是路径方法要正确。<br></font><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">第一，注册制的提法既然用了也不必轻易改，但需要给一个明确的定义。</span><br><span class="line">我们想搞的注册制到底是什么，不是什么，让大家明确目标。</span><br><span class="line"></span><br><span class="line">第二，把当前的情况分析清楚。</span><br><span class="line">我们离那个制度相差多远，其中有哪几个主要障碍，怎样一一攻克，这样才能为注册制以后有可能的实行扫清障碍。</span><br><span class="line"></span><br><span class="line">第三，每走一步都要看到政府、市场、投资者的承受力和我们行动能力的边界。</span><br><span class="line">一步一个脚印，避免进一步、退两步，那样损失代价反而更大。</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/21/华生--01--改革最忌欲速而不达，成功取决于路径和方法/" data-id="cjj7xy5h5000qwes6ljfyw6t5" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/economics/">economics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technique/">technique</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/07/05/how_to_install_virtualenv/">how_to_install_virtualenv</a>
          </li>
        
          <li>
            <a href="/2018/06/28/How_to_manage_concurrency_in_Django_models/">How to manage concurrency in Django models</a>
          </li>
        
          <li>
            <a href="/2018/06/28/Bullet_Proofing_Django_Models/">Bullet Proofing Django Models</a>
          </li>
        
          <li>
            <a href="/2018/05/21/阿里云SLB显示用户真实IP/">阿里云SLB显示用户真实IP</a>
          </li>
        
          <li>
            <a href="/2018/05/21/Nginx获取真实IP方案/">Nginx获取真实IP方案</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>